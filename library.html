<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Library</title>
<link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<link href="style-global.css" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<style>
  /* --- LIBRARY THEME VARIABLES --- */
  :root {
    --theme-purple: #9c27b0;
    --theme-red: #d32f2f;
    --card-bg: rgba(30, 30, 30, 0.8);        
    --card-header-bg: rgba(50, 50, 50, 0.9); 
    --card-header-txt: #eee; 
  }

  body {
    background: transparent;
    font-family: 'Segoe UI', sans-serif;
    color: #eee;
    margin: 0;
    padding: 0;
    height: 100vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  /* --- LAYOUT --- */
  .lib-container { display: flex; height: 100%; gap: 0; }

  /* SIDEBAR */
  .lib-sidebar {
      width: 200px; background: rgba(0, 0, 0, 0.6); border-right: 1px solid rgba(255, 255, 255, 0.1);
      display: flex; flex-direction: column; padding: 15px; flex-shrink: 0;
  }
  .lib-sidebar h3 {
      margin-top: 15px; color: #888; font-size: 16px; text-transform: uppercase; letter-spacing: 1px;
      padding-bottom: 5px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); margin-bottom: 5px; font-weight: 800;
  }
  .lib-sidebar h3:first-child { margin-top: 0; }
  .lib-sidebar ul { list-style: none; padding: 0; margin: 0; overflow-y: auto; }
  .lib-cat-item {
      padding: 8px 12px; margin-bottom: 2px; background: transparent; border-radius: 6px; cursor: pointer;
      transition: all 0.2s ease; color: #aaa; font-weight: 600; font-size: 15px; text-transform: capitalize; border-left: 3px solid transparent;
  }
  .lib-cat-item:hover { background: rgba(255, 255, 255, 0.1); color: #fff; }
  .lib-cat-item.active { background: rgba(255,255,255,0.15); color: var(--accent); border-left-color: var(--accent); }

  /* EDITOR AREA */
  .lib-editor {
      flex: 1; display: flex; flex-direction: column; padding: 20px 30px;
      background: rgba(0,0,0,0.2); overflow: hidden;
  }
  .lib-header {
      display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;
      padding-bottom: 15px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); flex-shrink: 0;
  }
  .lib-header h2 {
      margin: 0; font-size: 2rem; color: #fff; font-weight: 900; letter-spacing: 1px; text-transform: uppercase;
  }

  /* --- CARD GRID --- */
  .lib-scroll-area {
      flex: 1; overflow-y: auto; padding-right: 5px; display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      grid-auto-rows: min-content; gap: 20px; align-content: start; 
  }

  /* --- CARD STYLING --- */
  .lib-card {
      background: var(--card-bg); border-radius: 8px; overflow: hidden; display: flex; flex-direction: column;
      border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 4px 10px rgba(0,0,0,0.3); transition: transform 0.2s, box-shadow 0.2s;
      position: relative; animation: fadeIn 0.3s ease; backdrop-filter: blur(10px);
      cursor: grab; 
  }
  .lib-card:active { cursor: grabbing; transform: scale(0.98); }
  .lib-card:hover { border-color: #666; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
  .lib-card.dragging { opacity: 0.5; border: 2px dashed var(--accent); }

  .lc-header {
      background: var(--card-header-bg); padding: 12px 15px; display: flex; align-items: center; justify-content: center;
      border-bottom: 1px solid #444; position: relative;
  }
  .lc-title {
      font-size: 3rem; font-weight: 900; color: var(--card-header-txt); text-align: center; 
      text-transform: uppercase; margin: 0; width: 100%; white-space: normal; /* Allow wrap in view mode */
      line-height: 1.2;
  }

  .lc-body { padding: 20px; display: flex; flex-direction: column; gap: 10px; align-items: center; text-align: center; }
  .lc-note { font-size: 1.1rem; color: #ccc; line-height: 1.4; white-space: pre-wrap; }

  /* EDIT BTN ON CARD */
  .card-edit-btn {
      position: absolute; top: 8px; right: 8px; width: 30px; height: 30px; 
      background: rgba(0,0,0,0.5); border: 1px solid #555; border-radius: 4px; color: #ccc; 
      cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center;
  }
  .card-edit-btn:hover { background: var(--accent); color: #000; border-color: var(--accent); }

  /* TRIO IMAGES */
  .trio-grid { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-bottom: 10px; }
  .trio-sprite { width: 60px; height: 60px; object-fit: contain; filter: drop-shadow(0 2px 3px rgba(0,0,0,0.5)); }

  /* --- MODAL STYLES --- */
  .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.85); z-index: 1000; display: none;
      align-items: center; justify-content: center; backdrop-filter: blur(5px);
  }
  .modal-box {
      background: #1a1a1a; border: 1px solid #444; border-radius: 12px; width: 500px; padding: 25px;
      box-shadow: 0 0 30px rgba(0,0,0,0.8); display: flex; flex-direction: column; gap: 15px;
      animation: popIn 0.2s ease;
  }
  .modal-title { font-size: 1.5rem; font-weight: 900; color: #fff; text-transform: uppercase; border-bottom: 1px solid #333; padding-bottom: 10px; }
  
  .modal-inp-group { display: flex; flex-direction: column; gap: 5px; }
  .modal-label { font-size: 0.9rem; color: #888; font-weight: 700; text-transform: uppercase; }
  
  /* UPDATED INPUT STYLES FOR WRAPPING */
  .modal-input {
      background: #000; border: 1px solid #333; color: #fff; padding: 10px; border-radius: 6px;
      font-family: 'Segoe UI', sans-serif; font-size: 1.1rem; outline: none; 
      resize: vertical; min-height: 40px;
  }
  .modal-input:focus { border-color: var(--accent); }

  .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px; }
  
  .lib-btn {
      padding: 8px 20px; background: #333; border: 1px solid #555; color: #ccc; font-weight: 700;
      cursor: pointer; border-radius: 4px; transition: 0.2s; text-transform: uppercase; font-size: 0.9rem;
  }
  .lib-btn:hover { background: #444; color: #fff; }
  .lib-btn.save { background: var(--accent); color: #000; border-color: var(--accent); }
  .lib-btn.save:hover { filter: brightness(1.2); }
  .lib-btn.del { background: #3e0000; border-color: #600; color: #f88; }
  .lib-btn.del:hover { background: #600; color: #fff; }

  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
</style>
</head>
<body>

  <div class="lib-container">
      <div class="lib-sidebar" id="lib-cat-list"></div>
      <div class="lib-editor">
          <div class="lib-header">
              <h2 id="lib-current-title">Category</h2>
              <button class="lib-btn save" onclick="openEditModal(null)">
                  <i class="fas fa-plus"></i> Add New
              </button>
          </div>
          <div id="lib-item-list" class="lib-scroll-area">
              <div style="padding:20px; text-align:center; color:#555;">Loading...</div>
          </div>
      </div>
  </div>

  <div class="modal-overlay" id="edit-modal">
      <div class="modal-box">
          <div class="modal-title" id="modal-heading">Edit Item</div>
          
          <div class="modal-inp-group">
              <div class="modal-label">Title</div>
              <textarea class="modal-input" id="edit-title" rows="2" placeholder="Item Title"></textarea>
          </div>

          <div class="modal-inp-group">
              <div class="modal-label" id="lbl-note">Note / Description</div>
              <textarea class="modal-input" id="edit-note" rows="5" placeholder="Details..."></textarea>
          </div>

          <div class="modal-actions">
              <button class="lib-btn del" id="btn-delete" onclick="deleteCurrentItem()">Delete</button>
              <button class="lib-btn" onclick="closeModal()">Cancel</button>
              <button class="lib-btn save" onclick="saveCurrentItem()">Save</button>
          </div>
      </div>
  </div>

<script>
  // FIREBASE SETUP
  const firebaseConfig = {
      apiKey: "AIzaSyDz82Dp56EISYqk3hza3upJ2pAjsStgMKo",
      authDomain: "pokemon-masters-d153a.firebaseapp.com",
      databaseURL: "https://pokemon-masters-d153a-default-rtdb.firebaseio.com",
      projectId: "pokemon-masters-d153a",
      storageBucket: "pokemon-masters-d153a.firebasestorage.app",
      messagingSenderId: "67655442054",
      appId: "1:67655442054:web:705baa26ffda58b5d3fb07",
      measurementId: "G-LGW9RJZDP3"
  };
  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // THEME SYNC
  window.addEventListener('message', (event) => {
      if (event.data && event.data.type === 'THEME_UPDATE') {
          document.documentElement.style.setProperty('--accent', event.data.color);
      }
  });
  if(window.parent) window.parent.postMessage({ type: 'REQUEST_THEME' }, '*');

  // CONFIG
  const LIBRARY_SECTIONS = {
      "Global Effects": {
          "Rewards": { path: "library/rewards", theme: "purple" },
          "Rules": { path: "library/rules", theme: "red" }
      },
      "Lists": {
          "Game Modes": { path: "library/gameModes" },
          "Legendary Trios": { path: "library/trios", type: "trio" },
          "Side Options": { path: "library/sides" },
          "Points List": { path: "library/points" },
          "SP List": { path: "library/sp" },
          "Shit Wheel": { path: "library/ShitWheelList" },
          "Tokens": { path: "library/TokenList" }
      }
  };

  const DEFAULT_TRIOS = [
    { text: "Kanto Birds", note: "Articuno, Zapdos, Moltres" },
    { text: "Johto Beasts", note: "Suicune, Entei, Raikou" },
    { text: "Weather Trio", note: "Groudon, Kyogre, Rayquaza" }
  ];

  let currentLibPath = null;
  let currentType = "std";
  let currentItems = []; // Array to hold ordered items
  let editingKey = null; // Key of item currently being edited

  function initLibrarySidebar() {
      const listContainer = document.getElementById('lib-cat-list');
      if(!listContainer) return;
      listContainer.innerHTML = '';
      let firstItem = null;

      for (const [sectionName, sectionItems] of Object.entries(LIBRARY_SECTIONS)) {
          let header = document.createElement('h3');
          header.innerText = sectionName;
          listContainer.appendChild(header);
          let ul = document.createElement('ul');
          for (const [itemName, itemData] of Object.entries(sectionItems)) {
              let li = document.createElement('li');
              li.className = 'lib-cat-item';
              li.innerText = itemName;
              li.onclick = () => loadLibraryCategory(itemName, itemData.path, li, itemData.theme, itemData.type);
              if(!firstItem) firstItem = { name: itemName, path: itemData.path, el: li, theme: itemData.theme, type: itemData.type };
              ul.appendChild(li);
          }
          listContainer.appendChild(ul);
      }
      if(firstItem) loadLibraryCategory(firstItem.name, firstItem.path, firstItem.el, firstItem.theme, firstItem.type);
  }

  function loadLibraryCategory(name, dbPath, el, theme, type="std") {
      document.querySelectorAll('.lib-cat-item').forEach(i => i.classList.remove('active'));
      if(el) el.classList.add('active');
      document.getElementById('lib-current-title').innerText = name;

      const libContainer = document.querySelector('.lib-container');
      if(libContainer) libContainer.setAttribute('data-theme', theme || 'default');

      if(currentLibPath && currentLibPath !== dbPath) {
          db.ref(currentLibPath).off();
      }

      currentLibPath = dbPath;
      currentType = type;
      
      const container = document.getElementById('lib-item-list');
      container.innerHTML = '<div style="padding:20px; text-align:center; color:#888;">Loading...</div>';

      db.ref(currentLibPath).on('value', snap => {
          let val = snap.val();
          if(type === 'trio' && !val) {
             db.ref(currentLibPath).set(DEFAULT_TRIOS);
             return;
          }
          parseData(val);
          renderItems();
      });
  }

  function parseData(data) {
      currentItems = [];
      if (!data) return;

      if (Array.isArray(data)) {
          data.forEach((val, idx) => { if(val !== null) currentItems.push({ key: idx, val: val }); });
      } else if (typeof data === 'object') {
          Object.keys(data).forEach(key => currentItems.push({ key: key, val: data[key] }));
      }
  }

  function renderItems() {
      const container = document.getElementById('lib-item-list');
      container.innerHTML = '';

      if (currentItems.length === 0) {
          container.innerHTML = '<div style="padding:20px; text-align:center; color:#555;">List is empty. Add a new item.</div>';
          return; 
      }

      currentItems.forEach((item, index) => {
          let textVal = (typeof item.val === 'object') ? (item.val.text || "") : item.val;
          let noteVal = (typeof item.val === 'object') ? (item.val.note || "") : "";

          const card = document.createElement('div');
          card.className = 'lib-card';
          card.setAttribute('draggable', 'true');
          
          // STORE ORIGINAL INDEX TO TRACK DATA
          card.dataset.index = index; 

          // Drag Events
          card.addEventListener('dragstart', dragStart);
          card.addEventListener('dragover', dragOver);
          card.addEventListener('drop', drop);
          card.addEventListener('dragenter', dragEnter);
          card.addEventListener('dragleave', dragLeave);
          card.addEventListener('dragend', dragEnd); // <-- NEW LISTENER

          const header = document.createElement('div');
          header.className = 'lc-header';
          header.innerHTML = `
             <div class="lc-title">${textVal}</div>
             <button class="card-edit-btn" onclick="openEditModal('${item.key}')"><i class="fas fa-pen"></i></button>
          `;

          const body = document.createElement('div');
          body.className = 'lc-body';

          if(currentType === 'trio') {
              let pokemonNames = noteVal.split(',').map(s => s.trim()).filter(s => s.length > 0);
              let spriteHtml = pokemonNames.map(p => {
                  let clean = p.toLowerCase().replace(/[ .]/g, '-').replace(/'/g, '').replace('Ã©','e');
                  if(clean.includes('urshifu')) clean = 'urshifu-single-strike';
                  return `<img class="trio-sprite" src="https://img.pokemondb.net/sprites/home/normal/${clean}.png" title="${p}" onerror="this.style.display='none'">`;
              }).join('');
              body.innerHTML = `<div class="trio-grid">${spriteHtml}</div><div class="lc-note">${noteVal}</div>`;
          } else {
              body.innerHTML = `<div class="lc-note">${noteVal}</div>`;
          }

          card.appendChild(header);
          card.appendChild(body);
          container.appendChild(card);
      });
  }

  // --- DRAG AND DROP LOGIC (SHIFT STYLE) ---
  let dragSrcEl = null;

  function dragStart(e) {
      dragSrcEl = this;
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/html', this.innerHTML);
      this.classList.add('dragging');
  }

  function dragOver(e) {
      if (e.preventDefault) e.preventDefault(); // Necessary to allow dropping
      e.dataTransfer.dropEffect = 'move';
      return false;
  }

  function dragEnter(e) {
      // Ignore if entering self or children
      if (this === dragSrcEl) return;
      
      const container = document.getElementById('lib-item-list');
      // Convert NodeList to Array to find indices
      const cards = [...container.querySelectorAll('.lib-card')];
      const srcIndex = cards.indexOf(dragSrcEl);
      const targetIndex = cards.indexOf(this);

      // VISUAL SHIFT: Move the dragged element in the DOM
      if (srcIndex < targetIndex) {
          // Dragging forward -> Insert AFTER target
          container.insertBefore(dragSrcEl, this.nextSibling);
      } else {
          // Dragging backward -> Insert BEFORE target
          container.insertBefore(dragSrcEl, this);
      }
      
      this.style.borderColor = 'var(--accent)';
  }

  function dragLeave(e) {
      this.style.borderColor = 'rgba(255,255,255,0.1)';
  }

  function drop(e) {
      if (e.stopPropagation) e.stopPropagation();
      this.style.borderColor = 'rgba(255,255,255,0.1)';
      
      // REBUILD DATA FROM NEW VISUAL ORDER
      saveReorderedList();
      return false;
  }

  function dragEnd(e) {
      this.classList.remove('dragging');
      // Ensure border reset on all cards
      document.querySelectorAll('.lib-card').forEach(c => c.style.borderColor = 'rgba(255,255,255,0.1)');
  }

  function saveReorderedList() {
      const container = document.getElementById('lib-item-list');
      const newOrderCards = container.querySelectorAll('.lib-card');
      
      // Map the visual order back to the data objects
      let newArr = [];
      newOrderCards.forEach(card => {
          // Use the original index stored in dataset to find the data object
          let originalIdx = parseInt(card.dataset.index);
          newArr.push(currentItems[originalIdx].val);
      });

      // Upload new order to Firebase
      db.ref(currentLibPath).set(newArr);
  }

  // --- MODAL LOGIC ---
  const modal = document.getElementById('edit-modal');
  const inpTitle = document.getElementById('edit-title');
  const inpNote = document.getElementById('edit-note');
  const lblNote = document.getElementById('lbl-note');
  const btnDel = document.getElementById('btn-delete');

  window.openEditModal = function(key) {
      editingKey = key;
      modal.style.display = 'flex';

      if(key === null) {
          // ADD NEW
          document.getElementById('modal-heading').innerText = "Add New Item";
          inpTitle.value = "";
          inpNote.value = "";
          btnDel.style.display = 'none';
      } else {
          // EDIT EXISTING
          document.getElementById('modal-heading').innerText = "Edit Item";
          let item = currentItems.find(i => i.key == key);
          if(item) {
              let t = (typeof item.val === 'object') ? (item.val.text || "") : item.val;
              let n = (typeof item.val === 'object') ? (item.val.note || "") : "";
              inpTitle.value = t;
              inpNote.value = n;
          }
          btnDel.style.display = 'block';
      }

      lblNote.innerText = (currentType === 'trio') ? "Pokemon List (Comma Separated)" : "Note / Description";
  }

  window.closeModal = function() {
      modal.style.display = 'none';
      editingKey = null;
  }

  window.saveCurrentItem = function() {
      if(!currentLibPath) return;
      
      let newTitle = inpTitle.value;
      let newNote = inpNote.value;
      let payload = { text: newTitle, note: newNote };

      if(editingKey === null) {
          db.ref(currentLibPath).push(payload);
      } else {
          db.ref(currentLibPath + '/' + editingKey).set(payload);
      }
      closeModal();
  }

  window.deleteCurrentItem = function() {
      if(!currentLibPath || !editingKey) return;
      if(confirm("Are you sure you want to delete this item?")) {
          db.ref(currentLibPath + '/' + editingKey).set(null);
          closeModal();
      }
  }

  initLibrarySidebar();
</script>
</body>
</html>