<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Match History</title>
<link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<link href="style-global.css" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<style>
  :root {
    --theme-green: var(--accent);
    --glass-bg: rgba(20, 20, 20, 0.95);
    --border-color: rgba(255, 255, 255, 0.15);
    --text-dim: #888;
    
    --p1-color: #ff4444;
    --p2-color: #4488ff;
    font-size: 25px;
  }

  body { 
    font-family: 'Segoe UI', sans-serif; 
    color: #eee; 
    margin: 0; 
    padding: 20px; 
    background: transparent; 
    height: 100vh;
    overflow-y: auto;
  }

  /* STAT CARDS */
  .stats-overview {
      display: grid; grid-template-columns: 1fr 1fr; gap: 20px;
      margin-bottom: 25px; animation: slideIn 0.4s ease-out;
  }
  .stat-card {
      background: var(--glass-bg); border: 1px solid var(--border-color); border-radius: 12px;
      padding: 15px 25px; display: flex; flex-direction: column; gap: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.4); position: relative; overflow: hidden;
  }
  .stat-card::before { content: ''; position: absolute; top:0; left:0; width:100%; height:4px; }
  .sc-alb::before { background: var(--p1-color); box-shadow: 0 0 10px var(--p1-color); }
  .sc-biu::before { background: var(--p2-color); box-shadow: 0 0 10px var(--p2-color); }

  .stat-header {
      font-size: 1.4rem; font-weight: 900; text-transform: uppercase; letter-spacing: 1px;
      padding-bottom: 10px; margin-bottom: 5px; border-bottom: 1px solid rgba(255,255,255,0.1);
      display: flex; justify-content: space-between; align-items: center;
  }
  .stat-row { display: flex; justify-content: space-between; align-items: center; padding: 2px 0; }
  .stat-label { color: #888; font-size: 0.8rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
  .stat-val { font-size: 1.1rem; font-weight: 800; color: #fff; text-shadow: 0 0 5px rgba(0,0,0,0.5); }
  .stat-divider { height: 1px; background: rgba(255,255,255,0.05); margin: 5px 0; }
  .chal-highlight { color: #d400ff; }

  /* HEADER ACTIONS */
  .header-actions { display: flex; justify-content: flex-end; margin-bottom: 20px; }
  .btn-add {
    background: #111; border: 1px solid #444; color: var(--theme-green);
    padding: 8px 16px; border-radius: 6px; font-weight: 700; cursor: pointer;
    text-transform: uppercase; transition: 0.2s; display: flex; align-items: center; gap: 8px;
  }
  .btn-add:hover { background: var(--theme-green); color: #000; box-shadow: 0 0 15px var(--theme-green); }

  /* HISTORY LIST */
  #hist-list { display: flex; flex-direction: column; gap: 15px; padding-bottom: 50px; }

  .match-block {
    background: var(--glass-bg); border: 1px solid var(--border-color); border-radius: 8px;
    overflow: hidden; animation: slideIn 0.3s ease-out; box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    transition: transform 0.2s, border-color 0.2s;
  }
  .match-block.dragging { opacity: 0.4; transform: scale(0.98); }
  .match-block.drop-target { border-top: 4px solid var(--theme-green); margin-top: -3px; }

  @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

  /* DATE ROW UPDATED */
  .match-date-row {
    background: rgba(255, 255, 255, 0.08); padding: 6px 25px; font-size: 0.75rem; font-weight: 700;
    color: var(--text-dim); border-bottom: 1px solid var(--border-color);
    display: flex; justify-content: space-between; align-items: center;
    cursor: pointer; transition: 0.2s;
  }
  .match-date-row:hover { background: rgba(255, 255, 255, 0.12); }
   
  .drag-handle { cursor: grab; color: #555; margin-right: 12px; font-size: 14px; padding: 4px; transition: color 0.2s; }
  .drag-handle:hover { color: var(--theme-green); }

  .date-left { display: flex; align-items: center; }
  .date-right { display: flex; align-items: center; gap: 15px; }

  /* CHALLENGE BADGE */
  .chal-badge {
    background: rgba(0, 0, 0, 0.3); 
    color: var(--theme-green); 
    border: 1px solid var(--theme-green);
    font-size: 0.7rem; padding: 2px 8px;
    border-radius: 4px; font-weight: 900; text-transform: uppercase;
    box-shadow: 0 0 2px var(--theme-green);
    letter-spacing: 1px;
  }

  .expand-arrow { transition: transform 0.3s ease; font-size: 14px; color: #888; }
  .match-block.open .expand-arrow { transform: rotate(180deg); color: #fff; }

  /* --- NEW 2-ROW LAYOUT STYLES --- */
  .match-body {
    padding: 15px 25px;
    display: flex;
    flex-direction: column;
    gap: 12px; /* Space between the two rows */
  }

  /* ROW 1: Game Info */
  .m-row-1 {
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .info-group { display: flex; align-items: baseline; gap: 15px; }
  .m-mode { font-size: 1.1rem; font-weight: 800; color: #fff; letter-spacing: 0.5px; }
  
  .m-side { font-size: 0.9rem; font-weight: 600; color: #aaa; font-style: italic; }
  .sp-val { color: var(--theme-green); font-weight: 700; margin-left: 8px; font-size: 0.85em; opacity: 0.9; text-transform: uppercase; }
  
  .points-badge {
    background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
    padding: 4px 10px; border-radius: 6px; font-size: 0.9rem; font-weight: 700; color: #ccc;
    display: flex; gap: 10px;
  }
  .pb-val { color: #fff; }

  /* ROW 2: Results & Actions */
  .m-row-2 {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding-top: 10px;
    border-top: 1px solid rgba(255,255,255,0.05); /* Divider line */
  }

  .res-group { display: flex; align-items: center; }
  
  /* NEW DIVIDER CLASS */
  .r-divider {
      width: 1px; height: 18px; background: rgba(255,255,255,0.15); margin: 0 12px;
  }
  
  /* Winner Text */
  .m-winner { font-size: 1.2rem; font-weight: 900; text-transform: uppercase; margin-right: 15px; display: flex; align-items: center; gap: 8px; }

  .col-links { display: flex; gap: 6px; }
  .link-chip {
    background: #222; border: 1px solid #444; color: #ccc;
    font-size: 0.8rem; padding: 4px 8px; border-radius: 4px;
    text-decoration: none; transition: 0.2s; font-weight: 700;
  }
  .link-chip:hover { border-color: var(--theme-green); color: #fff; background: #333; }

  .rec-container { display: flex; gap: 4px; align-items: center; }
  .rec-badge {
      width: 35px; height: 30px; display: flex; align-items: center; justify-content: center;
      border-radius: 4px; font-weight: 900; font-size: 0.8rem; border: 1px solid rgba(255,255,255,0.1);
      box-shadow: 0 0 4px currentColor;
  }
   
  .col-actions { display: flex; gap: 15px; align-items: center; }
  .act-btn { background: transparent; border: none; color: #555; cursor: pointer; font-size: 1rem; width: 20px; text-align: center; transition: 0.2s; }
  .act-btn:hover { color: #fff; transform: scale(1.15); }
  .act-del:hover { color: #ff4444; } 

  /* DETAILS SECTION (The expanded part) */
  .match-details {
      display: none; /* Hidden by default */
      background: rgba(0,0,0,0.3);
      border-top: 1px solid rgba(255,255,255,0.05);
      padding: 15px 25px;
      font-size: 0.85rem;
  }
  .match-block.open .match-details { display: block; animation: fadeIn 0.3s; }
   
  .det-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }
  .det-item { 
      background: rgba(255,255,255,0.05); padding: 8px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.05);
      display: flex; flex-direction: column; gap: 4px;
  }
  .det-lbl { font-weight: 900; color: #666; font-size: 0.7rem; text-transform: uppercase; }
  .det-val { color: #ddd; font-size: 0.8rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .det-hl { color: var(--theme-green); }

  @keyframes fadeIn { from{opacity:0} to{opacity:1} }

  /* MODAL */
  .modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.85); z-index: 2000;
    display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px);
  }
  .modal-box {
    background: #111; border: 1px solid #333; border-radius: 12px;
    width: 850px; /* ⬅️ WIDER MODAL */
    padding: 30px; box-shadow: 0 0 30px rgba(0,0,0,0.8);
    display: flex; flex-direction: column; gap: 15px;
  }
  .modal-title { font-size: 1.4rem; font-weight: 900; color: var(--theme-green); text-transform: uppercase; margin-bottom: 10px; }
   
  .form-group { display: flex; flex-direction: column; gap: 5px; }
  .form-lbl { font-size: 0.75rem; color: #888; font-weight: 700; text-transform: uppercase; }
  .form-in { 
    width: 100%; background: #000; border: 1px solid #333; color: #fff; 
    padding: 10px; border-radius: 6px; box-sizing: border-box; font-family: inherit; font-size: 0.9rem;
  }
  .form-in:focus { outline: none; border-color: var(--theme-green); }

  /* ⬅️ UPDATED GRID FOR GAME ROWS */
  .game-row { 
      display: grid; 
      grid-template-columns: 30px 1fr 1fr 80px 1fr; 
      gap: 10px; align-items: center; 
      background: rgba(255,255,255,0.03); 
      padding: 5px 10px; border-radius: 6px; border: 1px solid #222; 
  }
  .game-label { font-weight: 800; color: #666; }
  .game-select { background: #000; color: #fff; border: 1px solid #444; padding: 5px; border-radius: 4px; width: 100%; }
  .game-input { background: #000; border: 1px solid #444; color: #ddd; padding: 5px; border-radius: 4px; width: 100%; }
  .game-input.small { font-size: 0.85rem; }

  .modal-btns { display: flex; gap: 10px; margin-top: 10px; justify-content: flex-end; }
  .m-btn { padding: 10px 25px; border-radius: 6px; font-weight: 800; cursor: pointer; border: none; }
  .m-cancel { background: #222; color: #ccc; border: 1px solid #333; }
  .m-save { background: var(--theme-green); color: #000; }
  .empty-state { text-align: center; color: #555; font-weight: 800; margin-top: 50px; font-size: 1.2rem; }
</style>
</head>
<body>

  <div class="stats-overview">
      <div class="stat-card sc-alb">
          <div class="stat-header" style="color:var(--p1-color)" id="stat-hdr-p1">P1</div>
          <div class="stat-row"><span class="stat-label">Total Games Won</span><span class="stat-val" id="s-alb-wins">0</span></div>
          <div class="stat-row"><span class="stat-label">Overall Win Rate</span><span class="stat-val" id="s-alb-wr">0%</span></div>
          <div class="stat-divider"></div>
          <div class="stat-row"><span class="stat-label chal-highlight">Challenge Wins</span><span class="stat-val" id="s-alb-cw">0</span></div>
          <div class="stat-row"><span class="stat-label chal-highlight">Chal. Win Rate</span><span class="stat-val" id="s-alb-cwr">0%</span></div>
      </div>
      <div class="stat-card sc-biu">
          <div class="stat-header" style="color:var(--p2-color)" id="stat-hdr-p2">P2</div>
          <div class="stat-row"><span class="stat-label">Total Games Won</span><span class="stat-val" id="s-biu-wins">0</span></div>
          <div class="stat-row"><span class="stat-label">Overall Win Rate</span><span class="stat-val" id="s-biu-wr">0%</span></div>
          <div class="stat-divider"></div>
          <div class="stat-row"><span class="stat-label chal-highlight">Challenge Wins</span><span class="stat-val" id="s-biu-cw">0</span></div>
          <div class="stat-row"><span class="stat-label chal-highlight">Chal. Win Rate</span><span class="stat-val" id="s-biu-cwr">0%</span></div>
      </div>
  </div>

  <div class="header-actions">
    <button class="btn-add" id="btn-manual-add" onclick="openModal()">
      <i class="fas fa-plus"></i> Manual Add
    </button>
  </div>

  <div id="hist-list">
    <div class="empty-state">Loading matches...</div>
  </div>

  <div class="modal-overlay" id="edit-modal">
    <div class="modal-box">
      <div class="modal-title" id="modal-title">Edit Match</div>
      <input type="hidden" id="edit-id">
      
      <div class="form-group">
        <label class="form-lbl">Overall Game Mode</label>
        <input class="form-in" id="in-mode" placeholder="e.g. This or That">
      </div>
      <div class="form-group">
        <label class="form-lbl">Overall Side Quest</label>
        <input class="form-in" id="in-side" placeholder="e.g. MegaMind">
      </div>
      
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px">
          <div class="form-group">
            <label class="form-lbl">Points</label>
            <input class="form-in" id="in-points" placeholder="1 Point">
          </div>
          <div class="form-group">
            <label class="form-lbl">SP</label>
            <input class="form-in" id="in-sp" placeholder="3">
          </div>
      </div>

      <div class="form-group">
          <label class="form-lbl">Overall Winner</label>
          <select class="form-in" id="in-winner" style="background:#000; border-color:#444;">
          </select>
      </div>

      <div class="form-group">
          <label class="form-lbl">Individual Game Records (Mode & Side Optional)</label>
          <div id="games-container" style="display:flex; flex-direction:column; gap:5px;">
          </div>
      </div>

      <div class="modal-btns">
        <button class="m-btn m-cancel" onclick="closeModal()">Cancel</button>
        <button class="m-btn m-save" onclick="saveData()">Save</button>
      </div>
    </div>
  </div>

<script>
  const firebaseConfig = { apiKey: "AIzaSyDz82Dp56EISYqk3hza3upJ2pAjsStgMKo", authDomain: "pokemon-masters-d153a.firebaseapp.com", databaseURL: "https://pokemon-masters-d153a-default-rtdb.firebaseio.com", projectId: "pokemon-masters-d153a", storageBucket: "pokemon-masters-d153a.firebasestorage.app", messagingSenderId: "67655442054", appId: "1:67655442054:web:705baa26ffda58b5d3fb07", measurementId: "G-LGW9RJZDP3" };
  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  window.p1Name = "ALB"; window.p2Name = "BIU";
  let cachedRawData = null;

  window.addEventListener('message', (event) => {
      if(event.data) {
          if (event.data.type === 'THEME_UPDATE') {
              document.documentElement.style.setProperty('--theme-green', event.data.color);
          }
          if (event.data.type === 'CONFIG_UPDATE') {
              if(event.data.p1Color) document.documentElement.style.setProperty('--p1-color', event.data.p1Color);
              if(event.data.p2Color) document.documentElement.style.setProperty('--p2-color', event.data.p2Color);
              if(event.data.p1Name) window.p1Name = event.data.p1Name;
              if(event.data.p2Name) window.p2Name = event.data.p2Name;
              
              document.getElementById('stat-hdr-p1').innerText = window.p1Name;
              document.getElementById('stat-hdr-p2').innerText = window.p2Name;
              
              if(cachedRawData) {
                  updateStats(cachedRawData);
                  renderAllMatches(cachedRawData);
              }
          }
      }
  });
  if(window.parent) window.parent.postMessage({ type: 'REQUEST_THEME' }, '*');

  db.ref('config').on('value', snap => {
      let c = snap.val() || {};
      if(c.p1Name) window.p1Name = c.p1Name;
      if(c.p2Name) window.p2Name = c.p2Name;
      if(c.p1Color) document.documentElement.style.setProperty('--p1-color', c.p1Color);
      if(c.p2Color) document.documentElement.style.setProperty('--p2-color', c.p2Color);
      document.getElementById('stat-hdr-p1').innerText = window.p1Name;
      document.getElementById('stat-hdr-p2').innerText = window.p2Name;
      if(cachedRawData) { updateStats(cachedRawData); renderAllMatches(cachedRawData); }
      generateModalRows();
  });

  db.ref('history').limitToLast(50).on('value', snap => {
      cachedRawData = snap.val();
      updateStats(cachedRawData);
      renderAllMatches(cachedRawData);
  });

  function generateModalRows() {
      const c = document.getElementById('games-container');
      c.innerHTML = '';
      for(let i=0; i<5; i++) {
          c.innerHTML += `
            <div class="game-row">
                <span class="game-label">G${i+1}</span>
                <input class="game-input small" id="rec-mode-${i}" placeholder="Mode">
                <input class="game-input small" id="rec-side-${i}" placeholder="Side Quest">
                <select class="game-select" id="rec-res-${i}">
                    <option value="-">-</option>
                    <option value="A">P1</option>
                    <option value="B">P2</option>
                </select>
                <input class="game-input" id="rec-link-${i}" placeholder="Link...">
            </div>
          `;
      }
  }

  function renderAllMatches(raw) {
      const container = document.getElementById('hist-list');
      container.innerHTML = "";
      if(!raw) { container.innerHTML = '<div class="empty-state">No matches found.</div>'; return; }
      const entries = Object.entries(raw).sort((a,b) => (b[1].timestamp||0) - (a[1].timestamp||0));
      entries.forEach(([key, data]) => renderMatchBlock(key, data, container));
  }

  function updateStats(data) {
      if(!data) return;
      let p1Wins=0, p2Wins=0, total=0, p1Chal=0, p2Chal=0, chalTotal=0;
      Object.values(data).forEach(match => {
          let w = (match.winner || "").toUpperCase().trim();
          let isChal = (match.settings && match.settings.mode === 'Challenge');
          if(w === window.p1Name.toUpperCase() || w === 'ALB') {
              p1Wins++; total++; if(isChal) { p1Chal++; chalTotal++; }
          } else if(w === window.p2Name.toUpperCase() || w === 'BIU') {
              p2Wins++; total++; if(isChal) { p2Chal++; chalTotal++; }
          }
      });
      let p1WR = total > 0 ? ((p1Wins/total)*100).toFixed(1) : 0;
      let p2WR = total > 0 ? ((p2Wins/total)*100).toFixed(1) : 0;
      let p1CWR = chalTotal > 0 ? ((p1Chal/chalTotal)*100).toFixed(1) : 0;
      let p2CWR = chalTotal > 0 ? ((p2Chal/chalTotal)*100).toFixed(1) : 0;

      document.getElementById('s-alb-wins').innerText = p1Wins;
      document.getElementById('s-alb-wr').innerText = p1WR + "%";
      document.getElementById('s-alb-cw').innerText = p1Chal;
      document.getElementById('s-alb-cwr').innerText = p1CWR + "%";
      document.getElementById('s-biu-wins').innerText = p2Wins;
      document.getElementById('s-biu-wr').innerText = p2WR + "%";
      document.getElementById('s-biu-cw').innerText = p2Chal;
      document.getElementById('s-biu-cwr').innerText = p2CWR + "%";
  }

  function renderMatchBlock(key, data, container) {
      let ts = data.timestamp || 0;
      let dateStr = new Date(ts).toLocaleString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric', hour: 'numeric', minute: 'numeric' });
      
      let mode = data.dashSnapshot ? data.dashSnapshot.mode : (data.mode || "Mixed");
      let side = data.dashSnapshot ? data.dashSnapshot.side : (data.side || "");
      let points = data.dashSnapshot ? data.dashSnapshot.points : (data.points || "-");
      let sp = data.dashSnapshot ? data.dashSnapshot.sp : (data.sp || "4"); 

      // Challenge Badge (Right Side)
      let isChallenge = (data.settings && data.settings.mode === 'Challenge');
      let chalBadgeHtml = isChallenge ? `<div class="chal-badge">CHALLENGE</div>` : "";

      // Winner Styling
      let displayWinner = data.winner;
      let winColor = '#fff';
      let w = (data.winner || "").toUpperCase().trim();
      let winIcon = "";
      
      if(w === window.p1Name.toUpperCase() || w === 'ALB') { 
          displayWinner = window.p1Name; 
          winColor = 'var(--p1-color)'; 
          winIcon = `<i class="fas fa-trophy" style="font-size:0.8rem; margin-right:2px; opacity:0.8"></i>`;
      }
      else if(w === window.p2Name.toUpperCase() || w === 'BIU') { 
          displayWinner = window.p2Name; 
          winColor = 'var(--p2-color)'; 
          winIcon = `<i class="fas fa-trophy" style="font-size:0.8rem; margin-right:2px; opacity:0.8"></i>`;
      }
      displayWinner = displayWinner.toUpperCase();

      // Records
      let recordHtml = `<div class="rec-container">`;
      let games = Array.isArray(data.record) ? data.record : [];
      if(games.length === 0 && typeof data.record === 'string') {
          let parts = data.record.split(/[\s-]+/);
          parts.forEach(p => { if(p) games.push({ result: p }); });
      }
      if(games.length === 0) for(let k=0; k<3; k++) games.push({result:'-'});

      // Expandable Details Content
      let detailsHtml = "";
      games.forEach((r, idx) => {
          let txt = r.result;
          let col = '#555';
          let bg = 'rgba(255,255,255,0.1)';
          if(txt === 'ALB' || txt === 'A' || txt === window.p1Name || txt === 'P1') {
              txt = window.p1Name.charAt(0); col = 'var(--p1-color)';
          } else if(txt === 'BIU' || txt === 'B' || txt === window.p2Name || txt === 'P2') {
              txt = window.p2Name.charAt(0); col = 'var(--p2-color)';
          }
          recordHtml += `<div class="rec-badge" style="color:${col}; border-color:${col}; background:${bg}">${txt}</div>`;
          
          // Show details if mode/side exists, regardless of challenge flag
          if(r.mode || r.side) {
              detailsHtml += `
                <div class="det-item">
                    <div class="det-lbl">Game ${idx+1}</div>
                    <div class="det-val"><span class="det-hl">Mode:</span> ${r.mode || '-'}</div>
                    <div class="det-val"><span class="det-hl">Side:</span> ${r.side || '-'}</div>
                </div>`;
          }
      });
      recordHtml += `</div>`;

      // Links
      let linkHtml = "";
      let links = data.links || [];
      if(typeof links === 'string') links = links.split(',');
      links.forEach((l, idx) => {
          let cleanLink = l.replace(/^G\d+:\s*/, '').trim(); 
          if(cleanLink) linkHtml += `<a href="${cleanLink}" target="_blank" class="link-chip">G${idx+1}</a>`;
      });
      
      // SP Display (Next to side)
      let spHtml = (sp && sp !== '-') ? `<span class="sp-val">SP: ${sp}</span>` : '';

      // --- NEW 2-ROW STRUCTURE ---
      let html = `
      <div class="match-block" id="block-${key}">
        <div class="match-date-row" onclick="toggleDetails('${key}')">
            <div class="date-left">
                <i class="fas fa-bars drag-handle"></i>
                <span>${dateStr}</span>
            </div>
            <div class="date-right">
                ${chalBadgeHtml}
                <i class="fas fa-chevron-down expand-arrow" id="arrow-${key}"></i>
            </div>
        </div>

        <div class="match-body">
            <div class="m-row-1">
                <div class="info-group">
                    <div class="m-mode">${mode}</div>
                    <div class="m-side">${side} ${spHtml}</div>
                </div>
                <div class="points-badge">
                    <span>${points}</span>
                </div>
            </div>

            <div class="m-row-2">
                <div class="res-group">
                    ${recordHtml}
                    <div class="r-divider"></div>
                    <div class="col-links">${linkHtml}</div>
                </div>
                
                <div class="res-group">
                    <div class="m-winner" style="color:${winColor}; text-shadow:0 0 10px ${winColor}">
                        ${winIcon} ${displayWinner}
                    </div>
                    <div class="col-actions">
                        <button class="act-btn" onclick="editEntry('${key}')"><i class="fas fa-pen"></i></button>
                        <button class="act-btn act-del" onclick="deleteEntry('${key}')"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <div class="match-details" id="det-${key}">
            ${detailsHtml ? `<div class="det-grid">${detailsHtml}</div>` : '<div style="color:#666; font-style:italic">No additional game details recorded.</div>'}
        </div>
      </div>`;
      container.innerHTML += html;
  }

  function toggleDetails(id) {
      const block = document.getElementById('block-' + id);
      block.classList.toggle('open');
  }

  function openModal() { document.getElementById('edit-modal').style.display = 'flex'; document.getElementById('modal-title').innerText = "Add Manual Match"; document.getElementById('edit-id').value = ""; clearInputs(); updateWinnerDropdown(); updateGameRows([]); }
  function editEntry(key) {
      db.ref('history/' + key).once('value').then(snap => {
          const d = snap.val();
          document.getElementById('edit-modal').style.display = 'flex'; document.getElementById('modal-title').innerText = "Edit Match"; document.getElementById('edit-id').value = key; updateWinnerDropdown();
          let mode = d.dashSnapshot ? d.dashSnapshot.mode : (d.mode || "");
          let side = d.dashSnapshot ? d.dashSnapshot.side : (d.side || "");
          let points = d.dashSnapshot ? d.dashSnapshot.points : (d.points || "");
          let sp = d.dashSnapshot ? d.dashSnapshot.sp : (d.sp || "");
          document.getElementById('in-mode').value = mode; document.getElementById('in-side').value = side; document.getElementById('in-points').value = points; document.getElementById('in-sp').value = sp;
          let w = (d.winner || "").toUpperCase();
          let sel = document.getElementById('in-winner');
          if(w === window.p1Name.toUpperCase() || w === 'ALB') sel.value = window.p1Name; else if(w === window.p2Name.toUpperCase() || w === 'BIU') sel.value = window.p2Name; else sel.value = d.winner;
          updateGameRows(d.record || [], d.links || []);
      });
  }
  function updateWinnerDropdown() { document.getElementById('in-winner').innerHTML = `<option value="${window.p1Name}">P1 - ${window.p1Name}</option><option value="${window.p2Name}">P2 - ${window.p2Name}</option><option value="-">No Winner</option>`; }
  
  function updateGameRows(record, links) { 
      if(!record) record = []; 
      if(!links) links = []; 
      for(let i=0; i<5; i++) { 
          let recVal = '-'; 
          let mVal = "";
          let sVal = "";
          
          // Handle record which now contains {result, mode, side}
          if(record[i]) { 
              let r = record[i].result; 
              if(r === 'A' || r === 'ALB') recVal = 'A'; 
              else if(r === 'B' || r === 'BIU') recVal = 'B'; 
              
              mVal = record[i].mode || "";
              sVal = record[i].side || "";
          } 
          
          document.getElementById(`rec-mode-${i}`).value = mVal;
          document.getElementById(`rec-side-${i}`).value = sVal;
          
          let sel = document.getElementById(`rec-res-${i}`); 
          sel.innerHTML = `<option value="-" ${recVal==='-'?'selected':''}>-</option><option value="A" ${recVal==='A'?'selected':''}>P1</option><option value="B" ${recVal==='B'?'selected':''}>P2</option>`; 
          
          let linkVal = ""; 
          if(links[i]) linkVal = links[i].replace(/^G\d+:\s*/, ''); 
          document.getElementById(`rec-link-${i}`).value = linkVal; 
      } 
  }
  
  function closeModal() { document.getElementById('edit-modal').style.display = 'none'; }
  function clearInputs() { ['in-mode','in-side','in-points','in-sp'].forEach(id => document.getElementById(id).value = ""); }
  
  function saveData() {
      const id = document.getElementById('edit-id').value; 
      let record = []; 
      let links = [];
      for(let i=0; i<5; i++) { 
          let res = document.getElementById(`rec-res-${i}`).value; 
          let link = document.getElementById(`rec-link-${i}`).value; 
          let m = document.getElementById(`rec-mode-${i}`).value;
          let s = document.getElementById(`rec-side-${i}`).value;
          
          // Save if any data exists for this row
          if(res !== '-' || m || s) {
              record.push({ result: res, mode: m, side: s }); 
          }
          if(link) links.push(link); 
      }
      
      const payload = { 
          mode: document.getElementById('in-mode').value, 
          side: document.getElementById('in-side').value, 
          points: document.getElementById('in-points').value, 
          sp: document.getElementById('in-sp').value, 
          winner: document.getElementById('in-winner').value, 
          record: record, 
          links: links, 
          timestamp: id ? undefined : Date.now() 
      };
      
      if(!id) payload.timestamp = Date.now(); else delete payload.timestamp; 
      if(id) db.ref('history/' + id).update(payload); else db.ref('history').push(payload);
      closeModal();
  }
  
  function deleteEntry(key) { if(confirm("Delete this match?")) db.ref('history/' + key).remove(); }
</script>
</body>
</html>