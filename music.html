/* main.js */
/* Entry point: Initializers and Global Event Listeners */

// USE GLOBAL DB (Defined in sync-manager.js)

// --- 1. GLOBAL MESSAGE LISTENER (Cross-Iframe Comms) ---
window.addEventListener('message', (event) => {
    if(event.data && event.data.type === 'REQUEST_THEME') {
        const c = window.currentAccent || '#00ff9d';
        if(event.source) event.source.postMessage({ type: 'THEME_UPDATE', color: c }, '*');
    }
    if (event.data && event.data.type === 'requestClearCols') {
        window.clearCol('alb'); 
        window.clearCol('biu');
    }
    if (event.data && event.data.type === 'GENERATOR_DROP') {
        window.handleReturnLogic();
    }
    if (event.data && event.data.type === 'INTERACTION_REPORT') {
        if(window.myRole === 'spectator') return;
        window.db.ref('presence/' + window.myRole + '/interaction').set({
            id: event.data.id,
            action: event.data.action,
            timestamp: Date.now()
        });
    }
});

// --- 2. INITIALIZATION ON LOAD ---
document.addEventListener('DOMContentLoaded', function() {
    window.initSlots('slots-alb'); 
    window.initSlots('slots-biu'); 
    
    if(window.initPresenceSystem) window.initPresenceSystem();
    
    window.toggleCollapse(); 
    window.toggleCenterCollapse(); 
    
    window.db.ref('library').once('value').then(snap => {
        window.appData = snap.val() || {};
        ['frame-play', 'frame-gen'].forEach(id => {
            let el = document.getElementById(id);
            if(el && el.contentWindow) { try { el.contentWindow.appData = window.appData; } catch(e) {} }
        });
    });

    // --- 3. ATTACH UNIVERSAL LISTENERS ---
    attachUniversalListeners();
});

function attachUniversalListeners() {
    // Exact IDs matching index.html
    const trackedIds = [
        'btn-theme-color', 'btn-theme-party', 'btn-fullscreen', 'btn-settings', // Theme Buttons
        'col-alb', 'col-biu', // Columns
        'top-bar-area', 'music-widget', // Title Areas
        'tab-btn-play', 'tab-btn-gen', 'tab-btn-music', 'tab-btn-hist', 'tab-btn-lib', // Tabs
        'score-alb', 'score-biu' // Scores
    ];

    trackedIds.forEach(id => {
        const el = document.getElementById(id);
        if(el) {
            // 1. Click Tracker
            el.addEventListener('mousedown', (e) => {
                if(window.reportInteraction) {
                    window.reportInteraction(id, 'click', e.pageX, e.pageY);
                }
            });

            // 2. Hover Start (Instant)
            el.addEventListener('mouseenter', () => {
                if(window.reportInteraction) {
                    window.reportInteraction(id, 'hover');
                }
            });

            // 3. Hover End (Instant Kill)
            el.addEventListener('mouseleave', () => {
                if(window.reportInteraction) {
                    window.reportInteraction(id, 'blur'); // 'blur' means stop hovering
                }
            });
        }
    });
}
