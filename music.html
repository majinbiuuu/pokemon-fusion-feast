<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;600;700;800&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<style>
  /* --- GLOBAL VARIABLES --- */
  :root {
    --theme-c: #00ff9d; 
    --glass-bg: rgba(10, 10, 10, 0.7);
    --border-c: rgba(255,255,255,0.1);
  }

  /* --- LAYOUT --- */
  body { margin:0; padding:0; background:transparent; font-family: 'Segoe UI', sans-serif; color:#eee; height:100vh; overflow:hidden; user-select: none; }
  
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: rgba(0,0,0,0.3); }
  ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
  ::-webkit-scrollbar-thumb:hover { background: #555; }

  .music-grid { display: grid; grid-template-columns: 1fr 340px; grid-template-rows: 100%; gap: 20px; height: 100%; padding: 20px; box-sizing: border-box; }
  .col-player { display: flex; flex-direction: column; gap: 15px; height: 100%; min-width: 0; }

  /* --- NOW PLAYING --- */
  .np-card { display: flex; align-items: center; gap: 15px; background: var(--glass-bg); border: 1px solid var(--border-c); border-radius: 12px; padding: 12px; height: 80px; flex-shrink: 0; box-shadow: 0 4px 15px rgba(0,0,0,0.5); position: relative; overflow: hidden; backdrop-filter: blur(10px); }
  
  .np-thumb-lg { height: 70px; width: 70px; object-fit: cover; border-radius: 8px; border: 1px solid #333; background: #000; z-index: 2; flex-shrink: 0; }
  
  .np-details { flex: 1; overflow: hidden; display: flex; flex-direction: column; justify-content: center; height: 100%; z-index: 2; position: relative; }

  .np-title-scroll { white-space: nowrap; font-size: 1.4rem; font-weight: 800; color: var(--theme-c); text-transform: uppercase; letter-spacing: 0.5px; overflow: hidden; display: flex; width: 100%; mask-image: linear-gradient(90deg, transparent, #000 2%, #000 98%, transparent); }
  .np-title-scroll span { display: inline-block; padding-right: 50px; }
  .scroll-active span { animation: marquee 12s linear infinite; }
  @keyframes marquee { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
   
  .np-timestamp { font-family: monospace; color: #aaa; font-size: 0.9rem; margin-top: 4px; font-weight: bold; }

  /* VISUALIZER */
  .visualizer { position: absolute; right: 20px; bottom: 15px; display: flex; gap: 6px; height: 35px; align-items: flex-end; opacity: 0.2; }
  .playing .visualizer { opacity: 1; }
  .v-bar { width: 8px; background: var(--theme-c); height: 4px; transition: height 0.1s; border-radius: 2px; }
  .playing .v-bar { animation: bounce 1s infinite ease-in-out; }
  @keyframes bounce { 0%, 100% { height: 10%; } 50% { height: 100%; } }
  .v-bar:nth-child(1) { animation-duration: 0.8s; } .v-bar:nth-child(2) { animation-duration: 1.1s; } 
  .v-bar:nth-child(3) { animation-duration: 0.9s; } .v-bar:nth-child(4) { animation-duration: 1.2s; } 
  .v-bar:nth-child(5) { animation-duration: 0.7s; }

  /* VIDEO STAGE */
  .video-stage { width: 100%; aspect-ratio: 16/9; background: rgba(0,0,0,0.5); border: 1px solid #333; border-radius: 12px; overflow: hidden; position: relative; box-shadow: 0 10px 40px rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; flex-grow: 1; max-height: calc(100vh - 250px); backdrop-filter: blur(5px); }
  #yt-player-mount { width: 100%; height: 100%; pointer-events: none; } 
  
  /* CONTROLS */
  .media-controls { height: 70px; background: var(--glass-bg); border: 1px solid var(--border-c); border-radius: 12px; padding: 10px 20px; display: flex; flex-direction: column; justify-content: space-evenly; flex-shrink: 0; backdrop-filter: blur(10px); }
  .progress-bar-wrap { width: 100%; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; cursor: pointer; position: relative; overflow: hidden; }
  .progress-wrap-hitbox { padding: 5px 0; cursor: pointer; } 
  .progress-fill { height: 100%; background: var(--theme-c); width: 0%; box-shadow: 0 0 10px var(--theme-c); transition: width 0.1s linear; }
   
  .ctrl-row { display: flex; justify-content: center; align-items: center; gap: 15px; height: 100%; }
  
  .media-btn { background: none; border: none; color: #ddd; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; width: 32px; height: 32px; border-radius: 50%; }
  .media-btn .material-icons { font-size: 22px; }
  .media-btn:hover { background: rgba(255,255,255,0.1); transform: scale(1.1); color: #fff; }
  .media-btn.active { color: var(--theme-c); text-shadow: 0 0 8px var(--theme-c); }
  
  .media-btn.main-play { width: 40px; height: 40px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); }
  .media-btn.main-play .material-icons { font-size: 28px; }
  .playing .media-btn.main-play { border-color: var(--theme-c); color: var(--theme-c); box-shadow: 0 0 10px rgba(0,255,157,0.1); }

  /* VOLUME */
  .vol-group { display: flex; align-items: center; gap: 8px; margin-left: 10px; padding-left: 15px; border-left: 1px solid rgba(255,255,255,0.1); }
  .vol-slider { -webkit-appearance: none; width: 80px; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; outline: none; }
  .vol-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 10px; height: 10px; background: #fff; border-radius: 50%; cursor: pointer; transition: 0.2s; }
  .vol-slider::-webkit-slider-thumb:hover { background: var(--theme-c); transform: scale(1.2); }

  /* QUEUE SIDEBAR */
  .col-queue { display: flex; flex-direction: column; background: var(--glass-bg); border: 1px solid var(--border-c); border-radius: 12px; overflow: hidden; backdrop-filter: blur(10px); height: 100%; }
  .q-tabs { display: flex; height: 45px; border-bottom: 1px solid var(--border-c); background: rgba(0,0,0,0.3); }
  .q-tab { flex: 1; display: flex; align-items: center; justify-content: center; font-weight: 700; color: #888; cursor: pointer; font-size: 0.85rem; transition: 0.2s; border-bottom: 2px solid transparent; text-transform: uppercase; letter-spacing: 1px; }
  .q-tab:hover { color: #ccc; background: rgba(255,255,255,0.02); }
  .q-tab.active { color: #fff; border-bottom-color: var(--theme-c); background: rgba(255,255,255,0.05); }
   
  .q-list { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 8px; }
  
  .q-item { display: flex; align-items: center; gap: 12px; padding: 8px; background: rgba(255,255,255,0.03); border: 1px solid transparent; border-radius: 8px; cursor: grab; transition: 0.2s; position: relative; min-height: 50px; }
  .q-item:active { cursor: grabbing; }
  .q-item:hover { background: rgba(255,255,255,0.08); transform: translateX(2px); }
  .q-item.playing { border-color: var(--theme-c); background: rgba(255, 255, 255, 0.05); }
  .q-item.dragging { opacity: 0.5; background: #222; border: 1px dashed #666; }

  /* WIDE THUMBNAIL 16:9 */
  .q-thumb { width: 100px; aspect-ratio: 16/9; object-fit: cover; border-radius: 4px; flex-shrink: 0; pointer-events: none; border: 1px solid #333; }
  
  .q-info { flex: 1; display: flex; flex-direction: column; overflow: hidden; justify-content: center; gap: 0; }
  .q-name { font-size: 0.9rem; font-weight: 700; color: #ddd; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .q-item.playing .q-name { color: var(--theme-c); }
  
  .q-remove { position: absolute; top: 50%; transform: translateY(-50%); right: 10px; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border-radius: 4px; cursor: pointer; color: transparent; transition: 0.2s; }
  .q-item:hover .q-remove { color: #777; }
  .q-remove:hover { background: #ff4444; color: #fff !important; }

  .add-bar { padding: 10px; background: rgba(0,0,0,0.5); border-top: 1px solid var(--border-c); display: flex; gap: 8px; }
  .add-input { background: rgba(0,0,0,0.5); border: 1px solid #444; color: #fff; padding: 8px; border-radius: 4px; font-size: 0.8rem; flex: 1; outline: none; transition: 0.2s; }
  .add-input:focus { border-color: var(--theme-c); background: #000; }
  .btn-act { padding: 0 15px; background: var(--theme-c); color: #000; border: none; font-weight: 800; cursor: pointer; border-radius: 4px; font-size: 0.8rem; transition: 0.2s; }
  .btn-icon { width: 32px; background: rgba(255,255,255,0.05); color: #fff; border: 1px solid #444; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
</style>
</head>
<body>

<div class="music-grid">
  <div class="col-player" id="main-player-ui">
    <div class="np-card">
      <img id="np-img-main" class="np-thumb-lg" src="">
      <div class="np-details">
        <div class="np-title-scroll" id="scroll-wrapper"><span id="np-title-main">Waiting for Sync...</span></div>
        <div class="np-timestamp" id="np-time-display">0:00 / 0:00</div>
      </div>
      <div class="visualizer">
        <div class="v-bar"></div><div class="v-bar"></div><div class="v-bar"></div><div class="v-bar"></div><div class="v-bar"></div>
      </div>
    </div>

    <div class="video-stage">
      <div id="yt-player-mount"></div>
    </div>

    <div class="media-controls">
      <div class="progress-wrap-hitbox" onclick="handleSeek(event)"><div class="progress-bar-wrap"><div class="progress-fill" id="prog-fill"></div></div></div>
      <div class="ctrl-row">
          <button class="media-btn" id="btn-shuffle" onclick="toggleShuffle()" title="Shuffle"><span class="material-icons">shuffle</span></button>
          <button class="media-btn" onclick="doPrev()"><span class="material-icons">skip_previous</span></button>
          <button class="media-btn main-play" id="btn-play-pause" onclick="togglePlayState()"><span class="material-icons">play_arrow</span></button>
          <button class="media-btn" onclick="doNext()"><span class="material-icons">skip_next</span></button>
          <button class="media-btn" id="btn-repeat" onclick="toggleRepeat()" title="Repeat"><span class="material-icons">repeat</span></button>
          <div class="vol-group">
            <button class="media-btn" onclick="toggleMute()" style="width:24px; height:24px;"><span class="material-icons" id="vol-icon" style="font-size:20px;">volume_up</span></button>
            <input type="range" class="vol-slider" id="vol-slider" min="0" max="100" value="100" oninput="setLocalVolume(this.value)">
          </div>
      </div>
    </div>
  </div>

  <div class="col-queue">
    <div class="q-tabs">
      <div class="q-tab active" id="tab-1" onclick="switchTab(1)">Playlist 1</div>
      <div class="q-tab" id="tab-2" onclick="switchTab(2)">Playlist 2</div>
    </div>
    <div class="q-list" id="queue-container"><div style="padding:20px; text-align:center; color:#555;">Loading...</div></div>
    <div class="add-bar">
      <input class="add-input" id="add-link-input" placeholder="YouTube Link or Search Term...">
      <button class="btn-icon" onclick="openSearch()" title="Search YouTube"><span class="material-icons" style="font-size:18px">search</span></button>
      <button class="btn-act" onclick="addVideo()">ADD</button>
    </div>
  </div>
</div>

<script>
  // FIREBASE CONFIG
  const firebaseConfig = {
      apiKey: "AIzaSyDz82Dp56EISYqk3hza3upJ2pAjsStgMKo",
      authDomain: "pokemon-masters-d153a.firebaseapp.com",
      databaseURL: "https://pokemon-masters-d153a-default-rtdb.firebaseio.com",
      projectId: "pokemon-masters-d153a",
      storageBucket: "pokemon-masters-d153a.firebasestorage.app",
      messagingSenderId: "67655442054",
      appId: "1:67655442054:web:705baa26ffda58b5d3fb07",
      measurementId: "G-LGW9RJZDP3"
  };
  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  var player;
  var currentList = 1;
  var currentId = "";
  var playlists = { list1: [], list2: [] };
  var localVol = localStorage.getItem('music_vol') || 100;
  var lastVol = 100; 
  var musicStatus = { state: "PAUSED", currentId: "", currentTitle: "Ready", timestamp: 0, shuffle: false, repeat: 0 };
  let dragSrcEl = null;
  let hasScannedTitles = false;
  let isInitialLoad = true; // Prevent autoplay on load

  // --- THEME & CONTROL SYNC (From Parent) ---
  window.addEventListener('message', (event) => {
      // 1. Theme
      if (event.data && event.data.type === 'THEME_UPDATE') {
          document.documentElement.style.setProperty('--theme-c', event.data.color);
      }
      
      // 2. Volume from Top Bar
      if(event.data.type === 'setVolume') {
          setLocalVolume(event.data.value, true); 
          const slider = document.getElementById('vol-slider');
          if(slider) slider.value = event.data.value;
      }

      // 3. Media Controls from Top Bar
      if (event.data && event.data.type === 'mediaControl') {
          handleMediaControl(event.data.action);
      }
  });
  if(window.parent) window.parent.postMessage({ type: 'REQUEST_THEME' }, '*');

  // --- PARENT MESSAGING (Updates Up) ---
  function setLocalVolume(val, fromSync = false) {
      localVol = val;
      if(val > 0) lastVol = val;
      localStorage.setItem('music_vol', val);
      
      if(player && player.setVolume) player.setVolume(val);
      updateVolIcon(val);

      if (!fromSync && window.parent) {
          window.parent.postMessage({ type: 'UPDATE_TOP_VOL', value: val }, '*');
      }
  };

  function handleMediaControl(action) {
      if(!player) return;
      if(action === 'play') togglePlayState();
      else if(action === 'next') doNext();
      else if(action === 'prev') doPrev();
  }

  function onPlayerReady(event) {
     player.setVolume(localVol);
     document.getElementById('vol-slider').value = localVol;
     updateVolIcon(localVol);
     if(musicStatus.currentId) player.cueVideoById(musicStatus.currentId);
  }

  // --- DB LISTENERS ---
  db.ref('music/playlists').on('value', snap => {
      const data = snap.val() || {};
      playlists.list1 = data.list1 || [];
      playlists.list2 = data.list2 || [];
      renderQueue();

      if(!hasScannedTitles && (playlists.list1.length > 0 || playlists.list2.length > 0)) {
          hasScannedTitles = true;
          scanAndFixTitles();
      }
  });

  db.ref('music/status').on('value', snap => {
      const serverStatus = snap.val();
      if(!serverStatus) return;
      musicStatus = serverStatus;
      
      document.getElementById('btn-shuffle').classList.toggle('active', musicStatus.shuffle);
      document.getElementById('btn-repeat').classList.toggle('active', musicStatus.repeat === 1);

      // Track Change
      if(musicStatus.currentId && musicStatus.currentId !== currentId) {
          currentId = musicStatus.currentId;
          updateNowPlaying(musicStatus.currentTitle, musicStatus.currentId);
          // Load but don't play yet if first load
          if(player && player.loadVideoById) {
              if (isInitialLoad) player.cueVideoById(currentId);
              else player.loadVideoById(currentId, Math.max(0, musicStatus.timestamp));
          }
          renderQueue(); 
      }
      
      // State Change (Play/Pause)
      let isPlaying = (musicStatus.state === 'PLAYING');
      document.getElementById('main-player-ui').classList.toggle('playing', isPlaying);
      
      // Update Local Button
      document.getElementById('btn-play-pause').innerHTML = isPlaying ? '<span class="material-icons">pause</span>' : '<span class="material-icons">play_arrow</span>';
      
      // Notify Parent Top Bar
      if(window.parent) window.parent.postMessage({ type: 'PLAYER_STATE', state: isPlaying ? 'playing' : 'paused' }, '*');

      if(player && player.getPlayerState) {
          let pState = player.getPlayerState();
          
          if(isInitialLoad) {
              // On first load, never auto-play. Just sync data.
              isInitialLoad = false;
          } else {
              if(isPlaying) {
                  if(pState !== 1 && pState !== 3) player.playVideo();
                  let localTime = player.getCurrentTime();
                  if(Math.abs(localTime - musicStatus.timestamp) > 2) player.seekTo(musicStatus.timestamp, true);
              } else {
                  if(pState === 1) player.pauseVideo();
              }
          }
      }
  });

  db.ref('music/cmd').on('value', snap => {
      const cmd = snap.val();
      if(!cmd) return;
      if(Date.now() - cmd.time < 3000) {
          if(cmd.action === 'next') doNext();
          if(cmd.action === 'prev') doPrev();
      }
  });

  // --- LOGIC ---
  function switchTab(n) {
      currentList = n;
      document.getElementById('tab-1').className = (n===1 ? 'q-tab active' : 'q-tab');
      document.getElementById('tab-2').className = (n===2 ? 'q-tab active' : 'q-tab');
      renderQueue();
  }

  function renderQueue() {
      const list = (currentList === 1) ? playlists.list1 : playlists.list2;
      const container = document.getElementById('queue-container');
      container.innerHTML = "";
      if(!list || list.length === 0) { container.innerHTML = '<div style="padding:20px; text-align:center; color:#555;">Playlist Empty</div>'; return; }

      list.forEach((item, index) => {
          let div = document.createElement('div');
          div.className = (item.id === currentId) ? 'q-item playing' : 'q-item';
          div.setAttribute('draggable', 'true');
          
          div.innerHTML = `
            <img class="q-thumb" src="${item.thumb}">
            <div class="q-info">
               <div class="q-name">${item.title}</div>
            </div>
            <div class="q-remove" onclick="removeVideo(event, ${index})"><span class="material-icons" style="font-size:16px">close</span></div>
          `;
          
          div.onclick = (e) => { if(!e.target.closest('.q-remove')) playSpecific(item); };
          div.addEventListener('dragstart', handleDragStart);
          div.addEventListener('dragenter', handleDragEnter);
          div.addEventListener('dragover', handleDragOver);
          div.addEventListener('dragleave', handleDragLeave);
          div.addEventListener('drop', handleDrop);
          div.addEventListener('dragend', handleDragEnd);
          div.dataset.index = index;
          container.appendChild(div);
      });
  }

  // --- DRAG & DROP (ROBUST SHIFT) ---
  function handleDragStart(e) { 
      dragSrcEl = this; 
      e.dataTransfer.effectAllowed = 'move'; 
      e.dataTransfer.setData('text/html', this.innerHTML); 
      this.classList.add('dragging'); 
  }

  function handleDragOver(e) { 
      if (e.preventDefault) e.preventDefault(); // Necessary to allow dropping
      
      // If hovering over itself, do nothing
      if (this === dragSrcEl) return false;

      const container = document.getElementById('queue-container');
      
      // Get the bounding rectangle of the item we are hovering over
      const bounding = this.getBoundingClientRect();
      
      // Calculate where the mouse is relative to the item's vertical center
      // (y position of mouse - y position of item top)
      const offset = e.clientY - bounding.top;
      
      // If mouse is in the upper half (offset < height/2), insert BEFORE
      // If mouse is in the lower half, insert AFTER
      if (offset < (bounding.height / 2)) {
          container.insertBefore(dragSrcEl, this);
      } else {
          container.insertBefore(dragSrcEl, this.nextSibling);
      }

      return false; 
  }

  function handleDragEnter(e) { 
      // Not needed for this method, but kept to prevent errors if listeners exist
  }

  function handleDragLeave(e) { 
      // Not needed
  }

  function handleDrop(e) {
      if (e.stopPropagation) e.stopPropagation();
      
      // The element is already in the correct spot visually.
      // We just need to save that new order to the database.
      savePlaylistOrder();
      return false;
  }

  function handleDragEnd(e) { 
      this.classList.remove('dragging'); 
      // Cleanup visual states
      document.querySelectorAll('.q-item').forEach(item => {
          item.classList.remove('over');
          item.style.opacity = '1';
      }); 
  }

  function savePlaylistOrder() {
      const container = document.getElementById('queue-container');
      const newOrderEls = container.querySelectorAll('.q-item');
      
      // 1. Get the source list (Clone it to avoid reference issues)
      let oldList = (currentList === 1) ? [...playlists.list1] : [...playlists.list2];
      let newList = [];

      // 2. Map visual DOM order back to data objects
      newOrderEls.forEach(el => {
          let originalIdx = parseInt(el.dataset.index);
          // Push the object from the old list using its original index
          if (oldList[originalIdx]) {
              newList.push(oldList[originalIdx]);
          }
      });

      // 3. Update Global Variables & Save to DB
      if (currentList === 1) playlists.list1 = newList;
      else playlists.list2 = newList;

      db.ref('music/playlists').set(playlists);
      
      // Optional: Re-render to reset data-indices, ensuring future drags are clean
      // (This prevents index drift if you drag multiple times without refreshing)
      renderQueue(); 
  }

  // --- ADD VIDEO ---
  async function addVideo() {
      let val = document.getElementById('add-link-input').value;
      if(!val) return;
      let id = "";
      try { 
         if(val.includes('v=')) id = val.split('v=')[1].split('&')[0];
         else if(val.includes('youtu.be/')) id = val.split('youtu.be/')[1].split('?')[0];
         else if(val.length === 11) id = val;
      } catch(e) {}

      if(id.length === 11) {
          let title = "Video " + id;
          let duration = "-:-";
          let apiSuccess = false;
          try {
             const res = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=snippet,contentDetails&id=${id}&key=${firebaseConfig.apiKey}`);
             const json = await res.json();
             if(json.items && json.items.length > 0) {
                 title = json.items[0].snippet.title;
                 duration = parseDuration(json.items[0].contentDetails.duration);
                 apiSuccess = true;
             }
          } catch(err) { console.log("API Fail, trying backup..."); }

          if(!apiSuccess) {
              let realTitle = await fetchOEmbedTitle(id);
              if(realTitle) title = realTitle;
          }

          let item = { id: id, title: title, thumb: "https://img.youtube.com/vi/"+id+"/mqdefault.jpg", duration: duration };
          if(currentList === 1) playlists.list1.push(item); else playlists.list2.push(item);
          db.ref('music/playlists').set(playlists);
          document.getElementById('add-link-input').value = "";
      }
  }

  async function fetchOEmbedTitle(id) {
      try {
          const res = await fetch(`https://noembed.com/embed?url=https://www.youtube.com/watch?v=${id}`);
          const json = await res.json();
          return json.title || null;
      } catch(e) { return null; }
  }

  async function scanAndFixTitles() {
      let changed = false;
      for(let i=0; i<playlists.list1.length; i++) {
          let item = playlists.list1[i];
          if(item.title.startsWith("Video " + item.id) || item.title === "Video " + item.id) {
               let real = await fetchOEmbedTitle(item.id);
               if(real) { playlists.list1[i].title = real; changed = true; }
          }
      }
      for(let i=0; i<playlists.list2.length; i++) {
          let item = playlists.list2[i];
          if(item.title.startsWith("Video " + item.id) || item.title === "Video " + item.id) {
               let real = await fetchOEmbedTitle(item.id);
               if(real) { playlists.list2[i].title = real; changed = true; }
          }
      }
      if(changed) db.ref('music/playlists').set(playlists);
  }
  
  function parseDuration(pt) {
      let match = pt.match(/PT(\d+H)?(\d+M)?(\d+S)?/);
      let h = (match[1] || '').replace('H','');
      let m = (match[2] || '').replace('M','');
      let s = (match[3] || '').replace('S','');
      if(h) return `${h}:${pad(m||0)}:${pad(s||0)}`;
      return `${m||0}:${pad(s||0)}`;
  }
  function pad(n) { return n<10?'0'+n:n; }

  function openSearch() {
      let val = document.getElementById('add-link-input').value;
      if(val) window.open(`https://www.youtube.com/results?search_query=${encodeURIComponent(val)}`, '_blank');
  }

  function setLocalVolume(val) {
      localVol = val;
      if(val > 0) lastVol = val;
      localStorage.setItem('music_vol', val);
      if(player && player.setVolume) player.setVolume(val);
      updateVolIcon(val);
  }

  function toggleMute() {
      let slider = document.getElementById('vol-slider');
      if(localVol > 0) { setLocalVolume(0); slider.value = 0; } 
      else { setLocalVolume(lastVol); slider.value = lastVol; }
  }

  function updateVolIcon(val) {
      let icon = document.getElementById('vol-icon');
      if(val == 0) icon.innerText = "volume_off";
      else if(val < 50) icon.innerText = "volume_down";
      else icon.innerText = "volume_up";
  }

  function handleSeek(e) {
      if(!player || !player.getDuration) return;
      var rect = e.currentTarget.getBoundingClientRect();
      var x = e.clientX - rect.left;
      var pct = x / rect.width;
      var newTime = player.getDuration() * pct;
      db.ref('music/status').update({ timestamp: newTime });
      player.seekTo(newTime, true);
  }

  function updateNowPlaying(title, id) {
      document.getElementById('np-img-main').src = "https://img.youtube.com/vi/"+id+"/mqdefault.jpg";
      let wrap = document.getElementById('scroll-wrapper');
      wrap.innerHTML = `<span id="np-title-main">${title}</span>`;
      let txt = document.getElementById('np-title-main');
      if(txt.offsetWidth > 250) { wrap.innerHTML += `<span>${title}</span>`; wrap.classList.add('scroll-active'); } 
      else { wrap.classList.remove('scroll-active'); }

      // SYNC TO TOP BAR
      if(window.parent) {
          window.parent.postMessage({
              type: 'TRACK_UPDATE',
              title: title,
              img: "https://img.youtube.com/vi/"+id+"/mqdefault.jpg"
          }, '*');
      }
  }

  setInterval(() => {
      if(player && player.getCurrentTime) {
          let cur = player.getCurrentTime();
          let dur = player.getDuration();
          if(dur > 0) {
              document.getElementById('prog-fill').style.width = ((cur/dur)*100) + "%";
              document.getElementById('np-time-display').innerText = fmt(cur) + " / " + fmt(dur);
          }
      }
  }, 500);

  function fmt(s) { let m=Math.floor(s/60); let sec=Math.floor(s%60); return m+":"+(sec<10?"0":"")+sec; }

  function onLocalPlayerStateChange(e) { 
      // 1 = Playing, 2 = Paused
      if (e.data === 1 || e.data === 2) { 
          if(player && player.getVideoData) {
              var vData = player.getVideoData();
              if(vData && vData.title) {
                  updateNowPlaying(vData.title, vData.video_id);
                  db.ref('music/status').update({ currentTitle: vData.title });
                  updatePlaylistTitleInDB(vData.video_id, vData.title);
              }
          }
      }
      if (e.data === 0) doNext(); 
  }

  function updatePlaylistTitleInDB(id, realTitle) {
      let found = false;
      let l1 = playlists.list1;
      let idx1 = l1.findIndex(x => x.id === id);
      if(idx1 > -1 && l1[idx1].title !== realTitle) { l1[idx1].title = realTitle; found = true; }
      
      let l2 = playlists.list2;
      let idx2 = l2.findIndex(x => x.id === id);
      if(idx2 > -1 && l2[idx2].title !== realTitle) { l2[idx2].title = realTitle; found = true; }

      if(found) db.ref('music/playlists').set(playlists);
  }

  function onYouTubeIframeAPIReady() {
    console.log("API Ready - Functions Loaded");
    player = new YT.Player('yt-player-mount', {
      height: '100%', width: '100%',
      playerVars: { 'autoplay': 0, 'controls': 0, 'disablekb': 1, 'origin': window.location.origin, 'playsinline': 1 },
      events: { 'onStateChange': onLocalPlayerStateChange, 'onReady': onPlayerReady }
    });
  }
</script>

<script src="https://www.youtube.com/iframe_api"></script>

</body>
</html>