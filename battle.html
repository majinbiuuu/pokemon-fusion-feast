<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Battle Data</title>
<link href="style-global.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<style>

    /* --- NEW TYPE CHART STYLES --- */
  .btn-types { 
      background: #444; color: #ccc; border: 1px solid #666; 
      padding: 0 20px; font-weight: 800; border-radius: 8px; 
      cursor: pointer; text-transform: uppercase; width: auto; 
      display: flex; align-items: center; justify-content: center;
      transition: 0.2s; letter-spacing: 1px;
  }
  .btn-types:hover { background: #eee; color: #000; border-color: #fff; }

  /* Modal Styles */
  .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }

  /* Update the width here üëá */
  .modal-content { 
      background: #161616; 
      border: 1px solid #444; 
      
      width: 400px; /* Changed from 500px to 800px */
      max-width: 95%; /* Allows it to fit on smaller screens */
      min-height: 450px; /* Adds a minimum height so it doesn't look squashed */
      
      max-height: 85vh; 
      border-radius: 12px; 
      padding: 30px; /* Increased padding slightly for better spacing */
      overflow-y: auto; 
      box-shadow: 0 20px 50px rgba(0,0,0,0.8); 
      position: relative; 
      display: flex;
      flex-direction: column;
  }
  .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 15px; }
  .close-modal { font-size: 2rem; cursor: pointer; line-height: 0.5; color: #888; }
  .close-modal:hover { color: #fff; }

  /* Type Grid & Details */
  .type-grid-select { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 10px; }
  .type-btn { padding: 12px; border-radius: 6px; border: none; font-weight: 800; text-transform: uppercase; cursor: pointer; color: #fff; text-align: center; text-shadow: 0 1px 3px rgba(0,0,0,0.6); transition: 0.2s; font-size: 0.9rem; }
  .type-btn:hover { transform: scale(1.05); filter: brightness(1.2); }
  
  .back-btn { background: none; border: none; color: #888; font-weight: 700; cursor: pointer; padding: 0; margin-bottom: 15px; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; }
  .back-btn:hover { color: #fff; }
  .detail-group { margin-bottom: 25px; }
  .d-head { font-size: 1.4rem; font-weight: 900; margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }
  .d-sub { font-size: 1rem; color: #aaa; margin-bottom: 8px; font-weight: 600; display: flex; align-items: center; gap: 6px; }
  .badge-list { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
  .icon-check { color: #44ff44; font-size: 1.2rem; }
  .icon-cross { color: #ff4444; font-size: 1.2rem; }

  /* --- THEME & BASICS --- */
  :root { --glass-bg: rgba(20, 20, 20, 0.6); --glass-border: rgba(255, 255, 255, 0.15); }
  body { font-family: 'Segoe UI', sans-serif; color: #eee; margin: 0; padding: 20px; overflow-y: auto; }

  /* SEARCH BAR */
  .search-row { display: flex; gap: 10px; margin-bottom: 20px; position: relative; }
  .poke-input { flex: 1; background: #111; border: 1px solid #444; color: #fff; padding: 12px; border-radius: 8px; font-size: 1.5rem; outline: none; transition: 0.2s; }
  .poke-input:focus { border-color: var(--accent); box-shadow: 0 0 10px var(--accent); }
  
  /* AUTOCOMPLETE */
  #autocomplete-list {
      position: absolute; top: 100%; left: 0; right: 180px; 
      background: #080808; border: 1px solid #444; border-top: none;
      border-bottom-left-radius: 8px; border-bottom-right-radius: 8px;
      max-height: 300px; overflow-y: auto; display: none; z-index: 1000;
      box-shadow: 0 10px 20px rgba(0,0,0,0.8);
  }
  .auto-item { padding: 12px 15px; cursor: pointer; border-bottom: 1px solid #222; font-size: 1.1rem; text-transform: capitalize; color: #aaa; transition: 0.1s; }
  .auto-item:hover { background: var(--accent); color: #000; font-weight: 800; }
  .auto-match { color: var(--accent); font-weight: 700; }
  .auto-item:hover .auto-match { color: #000; }

  /* BUTTONS */
  .btn-add { background: var(--accent); color: #000; border: none; padding: 0 20px; font-weight: 900; border-radius: 8px; cursor: pointer; text-transform: uppercase; width: 80px; }
  .btn-add:hover { filter: brightness(1.2); }
  .btn-clear { background: #333; color: #ccc; border: 1px solid #555; padding: 0 15px; font-weight: 700; border-radius: 8px; cursor: pointer; text-transform: uppercase; width: 80px; transition: 0.2s; }
  .btn-clear:hover { background: #d32f2f; color: #fff; border-color: #d32f2f; }

  /* GRID & CARDS */
  #battle-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); gap: 20px; }
  .b-card {
      background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 12px;
      padding: 20px; position: relative; animation: slideUp 0.3s ease;
      display: flex; flex-direction: column; gap: 15px; backdrop-filter: blur(10px); 
  }
  /* Find this block and replace it to remove the bottom border line */
  .b-header { 
      display: flex; 
      align-items: center; 
      gap: 5px; 
      padding-bottom: 5px;
  } 
  
  /* Larger Sprite Image */
  .b-sprite { 
      width: 120px;  /* üëà Increased from 80px */
      height: 120px; /* üëà Increased from 80px */
      object-fit: contain; 
      filter: drop-shadow(0 0 5px rgba(0,0,0,0.5)); 
  }

  .b-info { flex: 1; }
  .b-name { font-size: 1.8rem; font-weight: 900; text-transform: capitalize; color: #fff; line-height: 1.1; }
  .b-types { display: flex; gap: 5px; margin-top: 6px; }
  .type-badge { padding: 3px 10px; border-radius: 4px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }

  .b-sect-title { font-size: 1rem; font-weight: 700; color: #888; text-transform: uppercase; border-bottom: 1px solid #333; padding-bottom: 2px; margin-bottom: 8px; }
  /* Remove border for specific sections if needed via inline style, or helper class */
  .no-border { border-bottom: none !important; margin-bottom: 0 !important; }

  /* ITEMS ROW */
  .item-row { 
      display: flex; 
      flex-wrap: wrap; 
      gap: 2px; /* Reduced gap between items */
      margin-bottom: 4px; 
  }
  
  .item-chip {
      font-size: 0.9rem; 
      background: #222; 
      border: 1px solid #444; 
      color: #aaa; 
      
      /* üëá Reduced padding here (was 4px 8px) */
      padding: 2px 6px; 
      
      border-radius: 4px; 
      cursor: pointer; 
      text-transform: uppercase; 
      font-weight: 700; 
      transition: 0.2s;
  }
  .item-chip:hover { color: #fff; border-color: #666; }
  .item-chip.active-item { background: var(--accent); color: #000; border-color: var(--accent); }

  /* ABILITIES (Interactive) */
  .abil-row { display: flex; flex-wrap: wrap; gap: 8px; }
  .abil-wrapper { position: relative; }
  .abil-tag { 
      background: rgba(255,255,255,0.1); padding: 5px 10px; border-radius: 4px; font-size: 1.1rem; color: #ddd; 
      cursor: pointer; transition: 0.2s; border: 1px solid transparent; user-select: none;
  }
  .abil-tag:hover { background: #444; }
  .abil-tag.active-abil { 
      background: var(--accent); color: #000; border-color: #fff; font-weight: 700; box-shadow: 0 0 10px var(--accent);
  }
  .abil-hidden { border: 1px dashed #666; color: #aaa; }

  /* HOVER POPUP */
  .desc-popup {
      position: absolute; top: 0; left: 100%; margin-left: 10px; width: 220px; 
      background: #000; border: 1px solid #444; padding: 10px; border-radius: 6px;
      font-size: 1rem; color: #ccc; z-index: 100; display: none; box-shadow: 0 5px 15px rgba(0,0,0,0.8);
      line-height: 1.4; pointer-events: none;
  }
  .desc-popup::before {
      content: ""; position: absolute; top: 10px; right: 100%;
      border-width: 6px; border-style: solid; border-color: transparent #444 transparent transparent;
  }

  /* STATS */
  .stat-grid { display: flex; flex-direction: column; gap: 6px; background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px; }
  .stat-row { display: flex; align-items: center; gap: 10px; height: 24px; }
  .stat-lbl { width: 40px; font-size: 1rem; font-weight: 800; color: #888; text-transform: uppercase; text-align: right; }
  .stat-base { width: 40px; font-size: 1.1rem; font-weight: 700; color: #fff; text-align: center; }
  .stat-boosted { color: #00e5ff; text-shadow: 0 0 5px #00e5ff; } /* Cyan for boosted stats */
  
  .stat-bar-track { flex: 1; height: 6px; background: #333; border-radius: 3px; overflow: hidden; position: relative; }
  .stat-fill { height: 100%; border-radius: 3px; transition: width 0.5s ease; }
  
  .stat-range { width: 90px; font-size: 1.1rem; color: #666; text-align: right; font-family: monospace; display: flex; justify-content: space-between; padding-left: 10px; }
  .stat-range span:first-child { color: #ff5555; }
  .stat-range span:last-child { color: #55ff55; }

  /* DEFENSES */
  /* Find this block and replace it to remove the bottom border line */
  .b-header { 
      display: flex; 
      align-items: center; 
      gap: 15px; 
      /* Removed border-bottom and padding-bottom here */
  }

  /* ... other CSS ... */

  /* Replace the entire DEFENSES section with this to create the boxes */
  /* DEFENSES */
  .def-grid { display: flex; flex-wrap: wrap; gap: 8px; }
  
  .def-tag { 
      padding: 6px 12px; /* Added side padding for box look */
      background: rgba(0, 0, 0, 0.6); /* Dark background */
      border: 1px solid rgba(255, 255, 255, 0.15); /* Subtle border */
      border-radius: 6px; 
      font-size: 1.25rem; /* Increased multiplier font size */
      font-weight: 700; 
      display: flex; 
      align-items: center; 
      gap: 8px; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
  }

  .mult-4 { color: #44ff44; border-color: rgba(68, 255, 68, 0.3); } 
  .mult-2 { color: #88ff88; } 
  .mult-05 { color: #ff8888; opacity: 0.9; } 
  .mult-025 { color: #ff4444; } 
  .mult-0 { color: #888; text-decoration: none; opacity: 0.7; }

  .b-close { position: absolute; top: 10px; right: 10px; cursor: pointer; color: #555; transition: 0.2s; }
  .b-close:hover { color: #ff4444; }
  @keyframes slideUp { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
  
  .t-normal { background:#A8A77A; } .t-fire { background:#EE8130; } .t-water { background:#6390F0; }
  .t-electric { background:#F7D02C; } .t-grass { background:#7AC74C; } .t-ice { background:#96D9D6; }
  .t-fighting { background:#C22E28; } .t-poison { background:#A33EA1; } .t-ground { background:#E2BF65; }
  .t-flying { background:#A98FF3; } .t-psychic { background:#F95587; } .t-bug { background:#A6B91A; }
  .t-rock { background:#B6A136; } .t-ghost { background:#735797; } .t-dragon { background:#6F35FC; }
  .t-dark { background:#705746; } .t-steel { background:#B7B7CE; } .t-fairy { background:#D685AD; }
  
  /* FORMS */
  .form-row { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 5px; }
  .form-chip { background: #333; color: #aaa; padding: 4px 8px; border-radius: 4px; font-size: 1rem; cursor: pointer; border: 1px solid transparent; transition: 0.2s; }
  .form-chip:hover { color: #fff; background: #444; }
  .form-chip.active { border-color: var(--accent); color: var(--accent); background: rgba(255,255,255,0.05); font-weight: 700; }
</style>
</head>
<body>

  <div class="search-row">
    <input type="text" id="poke-search" class="poke-input" placeholder="Type Pokemon Name..." oninput="handleInput(this.value)" onkeypress="handleEnter(event)" autocomplete="off">
    <div id="autocomplete-list"></div>
    <button class="btn-add" onclick="addPokemon()">ADD</button>
    <button class="btn-clear" onclick="clearAllCards()">CLEAR</button>
    
    <button class="btn-types" onclick="openTypeModal()">TYPES</button>
</div>

  <div id="battle-grid"></div>

  <div id="type-modal" class="modal-overlay" onclick="closeTypeModal(event)">
  <div class="modal-content">
    <div class="modal-header">
      <h3 style="margin:0">Type Matchups</h3>
      <span class="close-modal" onclick="closeTypeModal()">√ó</span>
    </div>
    <div class="type-grid-select" id="type-selector"></div>
    <div id="type-detail-view" style="display:none;">
       <button class="back-btn" onclick="resetTypeModal()">‚Üê Select Type</button>
       <div id="type-data-content"></div>
    </div>
  </div>
</div>



<script>
  window.addEventListener('message', (event) => {
      if (event.data && event.data.type === 'THEME_UPDATE') {
          document.documentElement.style.setProperty('--accent', event.data.color);
      }
  });
  if(window.parent) window.parent.postMessage({ type: 'REQUEST_THEME' }, '*');

  // --- ABILITY EFFECTS DATABASE ---
  const ABILITY_MAP = {
      'levitate': { typeMod: {'ground': 0} },
      'flash-fire': { typeMod: {'fire': 0} },
      'volt-absorb': { typeMod: {'electric': 0} },
      'lightning-rod': { typeMod: {'electric': 0} },
      'motor-drive': { typeMod: {'electric': 0} },
      'water-absorb': { typeMod: {'water': 0} },
      'storm-drain': { typeMod: {'water': 0} },
      'sap-sipper': { typeMod: {'grass': 0} },
      'earth-eater': { typeMod: {'ground': 0} },
      'dry-skin': { typeMod: {'water': 0, 'fire': 1.25} },
      'thick-fat': { typeMod: {'fire': 0.5, 'ice': 0.5} },
      'heatproof': { typeMod: {'fire': 0.5} },
      'water-bubble': { typeMod: {'fire': 0.5} },
      'purifying-salt': { typeMod: {'ghost': 0.5} },
      'fluffy': { typeMod: {'fire': 2} },
      'wonder-guard': { special: 'wonder_guard' },
      
      'huge-power': { statMod: {'attack': 2} },
      'pure-power': { statMod: {'attack': 2} },
      'fur-coat': { statMod: {'defense': 2} },
      'gorilla-tactics': { statMod: {'attack': 1.5} },
      'intrepid-sword': { statMod: {'attack': 1.5} },
      'dauntless-shield': { statMod: {'defense': 1.5} }
  };

  // --- ITEM EFFECTS DATABASE ---
  const ITEM_MAP = {
      'band': { statMod: {'attack': 1.5} },
      'specs': { statMod: {'special-attack': 1.5} },
      'scarf': { statMod: {'speed': 1.5} },
      'orb': { statMod: {'attack': 1.3, 'special-attack': 1.3} },
      'vest': { statMod: {'special-defense': 1.5} },
      'eviolite': { statMod: {'defense': 1.5, 'special-defense': 1.5} }
  };

  // --- AUTOCOMPLETE LOGIC ---
  let allPokemonNames = [];
  fetch('https://pokeapi.co/api/v2/pokemon?limit=10000')
      .then(res => res.json()).then(data => { allPokemonNames = data.results.map(p => p.name); });

  function handleInput(val) {
      const list = document.getElementById('autocomplete-list');
      list.innerHTML = '';
      if (!val) { list.style.display = 'none'; return; }
      const matches = allPokemonNames.filter(n => n.includes(val.toLowerCase())).slice(0, 10);
      if (matches.length === 0) { list.style.display = 'none'; return; }
      matches.forEach(name => {
          const div = document.createElement('div');
          div.className = 'auto-item';
          const regex = new RegExp(`(${val})`, 'gi');
          div.innerHTML = name.replace(regex, '<span class="auto-match">$1</span>');
          div.onclick = () => {
              document.getElementById('poke-search').value = name;
              list.style.display = 'none';
              addPokemon();
          };
          list.appendChild(div);
      });
      list.style.display = 'block';
  }
  document.addEventListener('click', (e) => {
      if (!e.target.closest('.search-row')) document.getElementById('autocomplete-list').style.display = 'none';
  });

  // --- CLEAR FUNCTION ---
  function clearAllCards() {
      document.getElementById('battle-grid').innerHTML = "";
  }

  // --- DATA LOADING ---
  const typeChart = {
    normal: { fighting: 2, ghost: 0 },
    fire: { fire: 0.5, water: 2, grass: 0.5, ice: 0.5, ground: 2, bug: 0.5, rock: 2, steel: 0.5, fairy: 0.5 },
    water: { fire: 0.5, water: 0.5, electric: 2, grass: 2, ice: 0.5, steel: 0.5 },
    electric: { electric: 0.5, ground: 2, flying: 0.5, steel: 0.5 },
    grass: { fire: 2, water: 0.5, electric: 0.5, grass: 0.5, ice: 2, poison: 2, ground: 0.5, flying: 2, bug: 2 },
    ice: { fire: 2, ice: 0.5, fighting: 2, rock: 2, steel: 2 },
    fighting: { bug: 0.5, rock: 0.5, dark: 0.5, flying: 2, psychic: 2, fairy: 2 },
    poison: { grass: 0.5, fighting: 0.5, poison: 0.5, ground: 2, psychic: 2, bug: 0.5, fairy: 0.5 },
    ground: { water: 2, electric: 0, grass: 2, ice: 2, poison: 0.5, rock: 0.5 },
    flying: { electric: 2, grass: 0.5, ice: 2, fighting: 0.5, ground: 0, bug: 0.5, rock: 2 },
    psychic: { fighting: 0.5, psychic: 0.5, bug: 2, ghost: 2, dark: 2 },
    bug: { fire: 2, grass: 0.5, fighting: 0.5, ground: 0.5, flying: 2, rock: 2 },
    rock: { normal: 0.5, fire: 0.5, water: 2, grass: 2, fighting: 2, poison: 0.5, ground: 2, flying: 0.5, steel: 2 },
    ghost: { normal: 0, fighting: 0, poison: 0.5, bug: 0.5, ghost: 2, dark: 2 },
    dragon: { fire: 0.5, water: 0.5, electric: 0.5, grass: 0.5, ice: 2, dragon: 2, fairy: 2 },
    dark: { fighting: 2, psychic: 0, bug: 2, ghost: 0.5, dark: 0.5, fairy: 2 },
    steel: { normal: 0.5, fire: 2, grass: 0.5, ice: 0.5, fighting: 2, poison: 0, ground: 2, flying: 0.5, psychic: 0.5, bug: 0.5, rock: 0.5, dragon: 0.5, steel: 0.5, fairy: 0.5 },
    fairy: { fighting: 0.5, poison: 2, bug: 0.5, dragon: 0, dark: 0.5, steel: 2 }
  };

  function handleEnter(e) { if(e.key === 'Enter') addPokemon(); }

  async function addPokemon() {
      const input = document.getElementById('poke-search');
      const val = input.value;
      if(!val) return;
      const list = val.split('/');
      for(let raw of list) {
          let name = raw.trim().toLowerCase().replace(/ /g, '-').replace(/[^a-z0-9-]/g, '');
          if(!name) continue;
          try {
              const res = await fetch(`https://pokeapi.co/api/v2/pokemon/${name}`);
              if(!res.ok) throw new Error("Not Found");
              const pData = await res.json();
              const resSpec = await fetch(pData.species.url);
              const sData = await resSpec.json();
              renderCard(pData, sData);
          } catch(e) { console.error(e); }
      }
      input.value = "";
      document.getElementById('autocomplete-list').style.display = 'none';
  }

  function renderCard(p, s) {
      const container = document.getElementById('battle-grid');
      const div = document.createElement('div');
      div.className = 'b-card';
      div.id = `card-${p.name}-${Date.now()}`; 
      
      div._pData = p;
      div._sData = s;
      div._activeAbility = null; 
      div._activeItem = null; // New Item Tracker

      updateCardContent(div);
      container.insertBefore(div, container.firstChild);
  }

  // --- MAIN RENDER FUNCTION ---
  function updateCardContent(cardEl) {
      const p = cardEl._pData;
      const s = cardEl._sData;
      const activeAbilName = cardEl._activeAbility;
      const activeItem = cardEl._activeItem;

      // 1. Calculate Weaknesses
      const types = p.types.map(t => t.type.name);
      const defenses = calcDefenses(types, activeAbilName);
      const typeHtml = types.map(t => `<span class="type-badge t-${t}">${t}</span>`).join('');
      
      // 2. Prepare Stats
      const statsObj = {};
      p.stats.forEach(st => statsObj[st.stat.name] = st.base_stat);

      // 3. Render Abilities
      const abilHtml = p.abilities.map(a => {
          const nameClean = a.ability.name; 
          const nameDisp = nameClean.replace(/-/g,' ');
          const url = a.ability.url;
          const isActive = (nameClean === activeAbilName) ? 'active-abil' : '';
          return `
            <div class="abil-wrapper" 
                 onmouseenter="showAbilDesc(this, '${url}')" 
                 onmouseleave="hideAbilDesc(this)">
                <div class="abil-tag ${a.is_hidden ? 'abil-hidden' : ''} ${isActive}" 
                     onclick="toggleAbility('${cardEl.id}', '${nameClean}')">
                     ${nameDisp} ${a.is_hidden ? '<i style="font-size:1em">(H)</i>' : ''}
                </div>
                <div class="desc-popup">Loading...</div>
            </div>`;
      }).join('');

      // 4. Render Items (SPLIT INTO TWO ROWS)
      const row1Items = [
          {id: 'band', label: 'Choice Band'},
          {id: 'specs', label: 'Choice Specs'},
          {id: 'scarf', label: 'Choice Scarf'}
      ];
      
      const row2Items = [
          {id: 'orb', label: 'Life Orb'},
          {id: 'vest', label: 'Assault Vest'}
      ];
      
      // Helper to generate HTML for a list
      const renderItemRow = (list) => list.map(itm => {
          const isActive = (itm.id === activeItem) ? 'active-item' : '';
          return `<div class="item-chip ${isActive}" onclick="toggleItem('${cardEl.id}', '${itm.id}')">${itm.label}</div>`;
      }).join('');

      const row1Html = renderItemRow(row1Items);
      const row2Html = renderItemRow(row2Items);

      // 5. Render Forms
      let formsHtml = "";
      if(s && s.varieties.length > 1) {
          formsHtml = `<div class="b-sect-title">Forms</div><div class="form-row">`;
          s.varieties.forEach(v => {
              const fName = v.pokemon.name.replace(s.name, '').replace(/-/g, ' ').trim() || "Base";
              const isActive = (v.pokemon.name === p.name) ? "active" : "";
              formsHtml += `<div class="form-chip ${isActive}" onclick="switchForm('${cardEl.id}', '${v.pokemon.url}')">${fName}</div>`;
          });
          formsHtml += `</div>`;
      }

      cardEl.innerHTML = `
          <div class="b-close" onclick="this.parentElement.remove()"><span class="material-icons">close</span></div>
          <div class="b-header">
              <img class="b-sprite" src="${p.sprites.other['official-artwork'].front_default || p.sprites.front_default}">
              <div class="b-info">
                  <div class="b-name">${p.name.replace(/-/g, ' ')}</div>
                  <div class="b-types">${typeHtml}</div>
              </div>
          </div>

          ${formsHtml}

          <div class="b-sect-title">Base Stats</div>
          
          <div class="item-row" style="margin-bottom: 4px;">${row1Html}</div>
          <div class="item-row">${row2Html}</div>

          <div class="stat-grid">
              ${makeStat('HP', statsObj.hp, true)}
              ${makeStat('Atk', statsObj.attack, false, 'attack', activeAbilName, activeItem)}
              ${makeStat('Def', statsObj.defense, false, 'defense', activeAbilName, activeItem)}
              ${makeStat('SpA', statsObj['special-attack'], false, 'special-attack', activeAbilName, activeItem)}
              ${makeStat('SpD', statsObj['special-defense'], false, 'special-defense', activeAbilName, activeItem)}
              ${makeStat('Spe', statsObj.speed, false, 'speed', activeAbilName, activeItem)}
          </div>

          <div class="b-sect-title">Abilities (Click to Activate)</div>
          <div class="abil-row">${abilHtml}</div>

          <div class="b-sect-title">Weaknesses</div>
          <div class="def-grid">${defenses}</div>
      `;
  }

  // --- INTERACTIVITY ---
  window.toggleAbility = function(cardId, abilName) {
      const card = document.getElementById(cardId);
      if(!card) return;
      card._activeAbility = (card._activeAbility === abilName) ? null : abilName;
      updateCardContent(card);
  };

  window.toggleItem = function(cardId, itemId) {
      const card = document.getElementById(cardId);
      if(!card) return;
      card._activeItem = (card._activeItem === itemId) ? null : itemId;
      updateCardContent(card);
  };

  async function switchForm(cardId, url) {
      const cardEl = document.getElementById(cardId);
      if(!cardEl) return;
      cardEl.style.opacity = "0.5"; 
      try {
          const res = await fetch(url);
          const newP = await res.json();
          cardEl._pData = newP;
          cardEl._activeAbility = null;
          // Keep active item on form switch? Yes, usually preferred.
          updateCardContent(cardEl);
          cardEl.style.opacity = "1";
      } catch(e) { console.error(e); }
  }

  // --- STAT CALCULATOR (With Ability & Item Mods) ---
  function makeStat(lbl, val, isHP = false, statName = null, activeAbil = null, activeItem = null) {
      let displayVal = val;
      let isBoosted = false;
      
      // 1. Ability Mods
      if(activeAbil && !isHP && ABILITY_MAP[activeAbil] && ABILITY_MAP[activeAbil].statMod) {
          const mods = ABILITY_MAP[activeAbil].statMod;
          if(mods[statName]) {
              displayVal = Math.floor(displayVal * mods[statName]);
              isBoosted = true;
          }
      }

      // 2. Item Mods
      if(activeItem && !isHP && ITEM_MAP[activeItem] && ITEM_MAP[activeItem].statMod) {
          const iMods = ITEM_MAP[activeItem].statMod;
          if(iMods[statName]) {
              displayVal = Math.floor(displayVal * iMods[statName]);
              isBoosted = true;
          }
      }

      let pct = Math.min(100, (displayVal / 180) * 100);
      
      let min, max;
      if (isHP) {
          min = (2 * val) + 110; 
          max = (2 * val + 31 + 63) + 110;
      } else {
          // Approximate effect on final stats based on Base
          // If boosted, we show the boosted base roughly
          min = Math.floor(((2 * displayVal) + 5) * 0.9);
          max = Math.floor(((2 * displayVal + 31 + 63) + 5) * 1.1);
      }

      let color = "#ff4444"; 
      if(displayVal >= 100) color = "#44ff44"; 
      else if(displayVal >= 60) color = "#ffcc00"; 
      
      if(isBoosted) color = "#00e5ff"; // Cyan for boost

      return `
          <div class="stat-row">
              <div class="stat-lbl">${lbl}</div>
              <div class="stat-base ${isBoosted ? 'stat-boosted' : ''}">${displayVal}</div>
              <div class="stat-bar-track">
                  <div class="stat-fill" style="width:${pct}%; background:${color}"></div>
              </div>
              <div class="stat-range">
                  <span>${min}</span>
                  <span>${max}</span>
              </div>
          </div>
      `;
  }

  // --- DEFENSE CALCULATOR ---
  function calcDefenses(types, activeAbil) {
      let mults = {};
      Object.keys(typeChart).forEach(t => mults[t] = 1);

      types.forEach(defType => {
          const data = typeChart[defType];
          if(data) {
              Object.keys(data).forEach(atkType => {
                  mults[atkType] *= data[atkType];
              });
          }
      });

      if (activeAbil && ABILITY_MAP[activeAbil]) {
          const effect = ABILITY_MAP[activeAbil];
          if (effect.special === 'wonder_guard') {
              Object.keys(mults).forEach(t => {
                  if (mults[t] <= 1) mults[t] = 0; 
              });
          }
          if (effect.typeMod) {
              for (const [type, mod] of Object.entries(effect.typeMod)) {
                  if (mults[type] !== undefined) mults[type] *= mod;
              }
          }
      }

      let html = "";
      const sorted = Object.keys(mults).filter(k => mults[k] !== 1).sort((a,b) => mults[b] - mults[a]);
      sorted.forEach(t => {
          let m = mults[t];
          let cls = "";
          if(m >= 4) cls = "mult-4";
          else if(m >= 2) cls = "mult-2";
          else if(m === 0) cls = "mult-0";
          else if(m <= 0.25) cls = "mult-025";
          else cls = "mult-05";
          html += `<div class="def-tag ${cls}"><span class="type-badge t-${t}" style="font-size:0.8rem;">${t}</span> x${m}</div>`;
      });
      return html || "<span style='color:#666; font-size:1rem;'>Neutral to everything</span>";
  }

  // Hover logic
  async function showAbilDesc(wrapper, url) {
      const popup = wrapper.querySelector('.desc-popup');
      if(!popup) return;
      popup.style.display = 'block';
      if(popup.dataset.loaded === "true") return;
      try {
          const res = await fetch(url);
          const data = await res.json();
          const entry = data.effect_entries.find(e => e.language.name === 'en');
          popup.innerText = entry ? entry.short_effect : "No description available.";
          popup.dataset.loaded = "true";
      } catch(e) { popup.innerText = "Error loading description."; }
  }
  function hideAbilDesc(wrapper) {
      const popup = wrapper.querySelector('.desc-popup');
      if(popup) popup.style.display = 'none';
  }



  // --- NEW TYPE MODAL LOGIC ---
  const allTypes = Object.keys(typeChart);

  function openTypeModal() {
      const grid = document.getElementById('type-selector');
      grid.innerHTML = "";
      allTypes.forEach(t => {
          const btn = document.createElement('button');
          btn.className = `type-btn t-${t}`;
          btn.innerText = t;
          btn.onclick = () => showTypeDetails(t);
          grid.appendChild(btn);
      });
      resetTypeModal();
      document.getElementById('type-modal').style.display = 'flex';
  }

  function closeTypeModal(e) {
      if(!e || e.target.id === 'type-modal' || e.target.classList.contains('close-modal')) {
          document.getElementById('type-modal').style.display = 'none';
      }
  }

  function resetTypeModal() {
      document.getElementById('type-selector').style.display = 'grid';
      document.getElementById('type-detail-view').style.display = 'none';
  }

  function showTypeDetails(type) {
      document.getElementById('type-selector').style.display = 'none';
      const view = document.getElementById('type-detail-view');
      const content = document.getElementById('type-data-content');
      view.style.display = 'block';

      let atkGood = []; let atkBad = []; 
      let defGood = []; let defBad = []; 

      // 1. Attack Analysis: WE are Attacker (Check typeChart[DEFENDER][US])
      allTypes.forEach(defender => {
          let mod = (typeChart[defender] && typeChart[defender][type] !== undefined) ? typeChart[defender][type] : 1;
          if (mod > 1) atkGood.push(defender);
          if (mod < 1) atkBad.push(defender);
      });

      // 2. Defense Analysis: WE are Defender (Check typeChart[US][ATTACKER])
      allTypes.forEach(attacker => {
          let mod = (typeChart[type] && typeChart[type][attacker] !== undefined) ? typeChart[type][attacker] : 1;
          if (mod < 1) defGood.push(attacker);
          if (mod > 1) defBad.push(attacker);
      });

      const renderBadges = (list) => list.length ? list.map(t => `<span class="type-badge t-${t}" style="font-size:0.9rem; padding:5px 12px;">${t}</span>`).join('') : '<span style="color:#666; font-style:italic">None</span>';

      content.innerHTML = `
          <div style="text-align:center; margin-bottom:20px;">
              <span class="type-badge t-${type}" style="font-size:1.5rem; padding:5px 20px;">${type}</span>
          </div>
          <div class="detail-group">
              <div class="d-head">Attack <span style="color:#888; font-weight:400; font-size:1rem">pros & cons</span></div>
              <div class="d-sub"><span class="material-icons icon-check">check_circle</span> Super effective against:</div>
              <div class="badge-list">${renderBadges(atkGood)}</div>
              <div class="d-sub"><span class="material-icons icon-cross">cancel</span> Not very effective against:</div>
              <div class="badge-list">${renderBadges(atkBad)}</div>
          </div>
          <div style="border-top:1px solid #333; margin: 20px 0;"></div>
          <div class="detail-group">
              <div class="d-head">Defense <span style="color:#888; font-weight:400; font-size:1rem">pros & cons</span></div>
              <div class="d-sub"><span class="material-icons icon-check">check_circle</span> Resistant to:</div>
              <div class="badge-list">${renderBadges(defGood)}</div>
              <div class="d-sub"><span class="material-icons icon-cross">cancel</span> Weak to:</div>
              <div class="badge-list">${renderBadges(defBad)}</div>
          </div>`;
  }



</script>
</body>
</html>