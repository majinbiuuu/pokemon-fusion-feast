<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Season 3 - Fusion Feast</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;600;800;900&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  
  <link href="style-global.css" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="global.js"></script>

  <style>
    /* SHELL LAYOUT */
    html, body { 
      background-color: var(--bg); 
      background-position: center center;
      background-size: cover;
      background-attachment: fixed;
      background-repeat: no-repeat;
      color: var(--text); font-family: 'Segoe UI', sans-serif; 
      height: 100vh; overflow: hidden; display: flex; flex-direction: column; margin: 0; padding: 0; font-size: 14px; 
      transition: background-color 0.5s ease;
    }
    
    /* Overlay for text readability */
    body::before {
        content: ''; position: fixed; top:0; left:0; width:100%; height:100%;
        background: rgba(0,0,0,0.5); z-index: -1; pointer-events: none;
    }

    /* TOP BAR */
    .top-bar { height: 60px; display: flex; align-items: center; padding: 0 25px; background: rgba(10,10,10,0.6); backdrop-filter: blur(6px); border-bottom: var(--border); z-index: 1000; justify-content: space-between; }
    .top-left { display: flex; align-items: center; gap: 15px; flex: 1; }
    .status-badge { display: flex; align-items: center; gap: 8px; font-weight: bold; color: #888; font-size: 0.8rem; background: rgba(0,0,0,0.4); padding: 6px 14px; border-radius: 20px; border: var(--border); }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #444; transition: 0.3s; }
    .status-dot.active { background: #00ff9d; box-shadow: 0 0 10px #00ff9d; }
    
    .presence-text { font-size: 10px; color: var(--accent); font-weight: 700; margin-left: 8px; opacity: 0.8; letter-spacing: 0.5px; display: flex; gap: 5px; }
    
    /* NOW PLAYING WIDGET */
    .np-widget { flex: 0 1 auto; width: 420px; height: 42px; background: rgba(0,0,0,0.4); border: var(--border); border-radius: 8px; display: flex; align-items: center; overflow: hidden; margin: 0 20px; padding-right: 10px; }
    .np-thumb-mini { width: 75px; height: 100%; background: #111; object-fit: cover; border-right: 1px solid #333; }
    .np-info { flex: 1; overflow: hidden; padding: 0 12px; white-space: nowrap; mask-image: linear-gradient(90deg, transparent, #fff 5%, #fff 95%, transparent); }
    .np-text { font-size: 0.85rem; font-weight: 700; display: inline-block; color: var(--accent); }
    .np-controls { display: flex; align-items: center; gap: 5px; margin-right: 8px; border-right: 1px solid #333; padding-right: 8px; }
    .media-tiny-btn { width: 28px; height: 28px; border-radius: 4px; border: none; background: rgba(255,255,255,0.05); color: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
    .media-tiny-btn:hover { background: rgba(255,255,255,0.15); color: var(--accent); }
    .media-tiny-btn .material-icons { font-size: 18px; }

    /* VOLUME CONTROL */
    .top-vol { display: flex; align-items: center; gap: 6px; }
    .top-vol-slider { -webkit-appearance: none; width: 60px; height: 3px; background: #444; border-radius: 2px; outline: none; }
    .top-vol-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 8px; height: 8px; background: #ccc; border-radius: 50%; cursor: pointer; }
    .top-vol-slider::-webkit-slider-thumb:hover { background: var(--accent); }

    .top-right { display: flex; align-items: center; gap: 12px; flex: 1; justify-content: flex-end; }
    .theme-btn-group { display: flex; gap: 10px; }
    .theme-color-btn, .theme-party-btn, .theme-gear-btn { width: 32px; height: 32px; border-radius: 50%; background: #222; border: 1px solid #444; color: #888; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
    .theme-color-btn:hover, .theme-party-btn:hover, .theme-gear-btn:hover { color: #fff; border-color: var(--accent); background: rgba(255,255,255,0.1); }

    /* MAIN STAGE */
    .stage { flex: 1; display: grid; grid-template-columns: 240px 1fr 240px; gap: 20px; padding: 20px 25px 25px 25px; height: calc(100vh - 60px); box-sizing: border-box; }
    
    /* GLASS: Less Dark, Less Blur */
    .col-p { background: rgba(0,0,0,0.6); backdrop-filter: blur(6px); border: 1px solid #333; border-radius: 16px; padding: 15px; display: flex; flex-direction: column; gap: 15px; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
    
    .p-header { display: flex; flex-direction: column; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; margin-bottom: 5px; position: relative; }
    .p-top-row { display: flex; justify-content: space-between; width: 100%; align-items: center; margin-bottom: 10px; }
    .p-name { font-size: 2rem; font-weight: 900; letter-spacing: -1px; text-transform: uppercase; }
    .p-score { font-size: 3rem; font-weight: 900; line-height: 1; transition: color 0.2s; }
    .p-ctrls { display: flex; flex-direction: column; gap: 4px; }
    .tiny-btn { width: 28px; height: 28px; background: #1a1a1a; border: 1px solid #444; color: #888; cursor: pointer; border-radius: 6px; font-weight: 900; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
    .tiny-btn:hover { background: var(--accent); color: #000; border-color: var(--accent); box-shadow: 0 0 10px var(--accent); }
    
    .slot-list { display: flex; flex-direction: column; gap: 10px; flex: 1; }
    .slot { flex: 1; min-height: 65px; background: rgba(8,8,8,0.6); border: 1px dashed #333; border-radius: 8px; display: flex; align-items: center; justify-content: center; transition: 0.2s; position: relative; overflow: hidden; }
    .slot:hover { border-color: var(--accent); box-shadow: 0 0 10px var(--accent); }
    .slot.drag-over { border-color: var(--accent) !important; background: rgba(255,255,255, 0.05) !important; box-shadow: 0 0 15px var(--accent); transform: scale(1.02); }
    .slot.filled { border-style: solid; border-color: var(--accent); box-shadow: 0 0 10px var(--accent); background: rgba(17,17,17,0.8); }
    @keyframes snapIn { 0% { transform: scale(0.5); opacity: 0; } 70% { transform: scale(1.1); } 100% { transform: scale(1); opacity: 1; } }
    .slot img { height: 90%; width: auto; object-fit: contain; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.8)); z-index: 2; pointer-events: none; animation: snapIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    .slot-txt { display: none; }
    
    /* MOVED EXPORT BUTTON */
    .col-btn.export { 
        width: 50%; padding: 8px; background: rgba(255,255,255,0.05); border: 1px solid #444; 
        color: #888; font-weight: 800; cursor: pointer; border-radius: 20px; font-size: 1.2rem; 
        transition: 0.2s; display: flex; align-items: center; justify-content: center;
        margin-bottom: 5px;
    }
    .col-btn.export:hover { background: var(--accent); color: #000; border-color: var(--accent); box-shadow: 0 0 15px var(--accent); }
    .col-btn.clear-btn { width: 100%; padding: 10px; background: #1a1a1a; border: 1px solid #333; color: #666; font-weight: 800; cursor: pointer; border-radius: 8px; font-size: 0.75rem; letter-spacing: 1px; transition: 0.2s; margin-top: 10px;}
    .col-btn.clear-btn:hover { background: var(--red); color: #fff; border-color: var(--red); }

    .col-c { display: flex; flex-direction: column; background: rgba(15,15,15,0.5); backdrop-filter: blur(6px); border: var(--border); border-radius: 16px; overflow: hidden; position: relative; box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
    .tab-bar { display: flex; height: 55px; padding: 0 20px; align-items: center; gap: 20px; background: rgba(0,0,0,0.2); border-bottom: 1px solid rgba(255,255,255,0.05); flex-shrink: 0; justify-content: center; }
    .tab { position: relative; padding: 10px 20px; font-weight: 800; color: #666; cursor: pointer; transition: 0.3s; text-transform: uppercase; letter-spacing: 2px; font-size: 0.85rem; }
    .tab:hover { color: #ccc; }
    .tab.active { color: #fff; text-shadow: 0 0 15px rgba(255,255,255,0.3); }
    .tab.active::after { content: ''; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 30px; height: 3px; background: var(--accent); border-radius: 2px; box-shadow: 0 -2px 10px var(--accent); }
    .tab-content { flex: 1; overflow: hidden; display: none; height: 100%; width: 100%; position:relative; }
    .tab-content.active { display: block; }

    /* LOADING SPINNER FOR BUTTON */
    @keyframes spin { to { transform: rotate(360deg); } }
    .fa-spinner { animation: spin 1s linear infinite; }

    /* --- SETTINGS MODAL (CLEAN & COMPACT) --- */
    #settings-modal {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.8); z-index: 5000;
        display: none; justify-content: center; align-items: center;
        backdrop-filter: blur(5px);
    }
    .modal-box {
        background: rgba(20,20,20,0.95);
        border: 1px solid #444; border-radius: 12px;
        width: 480px; padding: 25px; /* Wider for better layout */
        box-shadow: 0 10px 40px rgba(0,0,0,0.9);
        display: flex; flex-direction: column; gap: 15px;
    }
    .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; padding-bottom: 12px; margin-bottom: 5px; }
    .modal-title { font-weight: 900; font-size: 1.1rem; color: #fff; letter-spacing: 1px; }
    .modal-close { cursor: pointer; color: #666; transition: 0.2s; font-size: 1.2rem; }
    .modal-close:hover { color: #fff; }
    
    .setting-group { display: flex; flex-direction: column; gap: 6px; }
    .setting-label { font-size: 0.7rem; font-weight: 800; color: var(--accent); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 2px;}
    
    .row-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    
    .flex-row { display: flex; gap: 8px; align-items: center; }
    
    .st-input {
        background: #111; border: 1px solid #333; color: #fff; padding: 6px 10px; border-radius: 4px;
        flex: 1; font-family: inherit; font-size: 0.85rem; transition: 0.2s;
    }
    .st-input:focus { outline: none; border-color: var(--accent); background: #151515; }
    
    .st-color { 
        width: 30px; height: 30px; padding: 0; background: none; border: none; cursor: pointer; 
        border-radius: 4px; overflow: hidden;
    }
    
    .st-btn {
        padding: 6px 12px; background: #222; border: 1px solid #444; color: #ccc; 
        cursor: pointer; border-radius: 4px; font-weight: 700; transition: 0.2s;
        text-align: center; font-size: 0.8rem;
    }
    .st-btn:hover { background: #333; color: #fff; border-color: #666; }
    .st-btn.action { border-color: var(--accent); color: var(--accent); }
    .st-btn.action:hover { background: var(--accent); color: #000; }

    /* Drag Drop Zone */
    #drop-zone {
        border: 2px dashed #444; border-radius: 6px; background: rgba(0,0,0,0.3);
        padding: 20px; text-align: center; color: #666; font-weight: 700; font-size: 0.8rem;
        transition: 0.2s; cursor: default;
    }
    #drop-zone.drag-over { border-color: var(--accent); background: rgba(0, 255, 157, 0.1); color: var(--accent); }

    /* Saved Wallpapers */
    .saved-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; margin-top: 5px; }
    .saved-thumb { 
        aspect-ratio: 16/9; background: #111; border: 1px solid #333; border-radius: 4px; 
        cursor: pointer; background-size: cover; background-position: center; position: relative;
        transition: 0.2s;
    }
    .saved-thumb:hover { border-color: var(--accent); transform: scale(1.05); }
    .del-thumb {
        position: absolute; top: -5px; right: -5px; width: 15px; height: 15px; background: #f44336; 
        color: white; border-radius: 50%; font-size: 10px; display: flex; align-items: center; justify-content: center;
        opacity: 0; transition: 0.2s;
    }
    .saved-thumb:hover .del-thumb { opacity: 1; }

  </style>
</head>
<body>
  
  <div id="settings-modal" onclick="if(event.target===this) toggleSettings()">
      <div class="modal-box">
          <div class="modal-header">
              <div class="modal-title">DASHBOARD SETTINGS</div>
              <div class="modal-close" onclick="toggleSettings()">&times;</div>
          </div>
          
          <div class="row-grid">
              <div class="setting-group">
                  <div class="setting-label">Player 1 (Left)</div>
                  <div class="flex-row">
                      <input type="text" id="st-p1-name" class="st-input" placeholder="Name" onchange="saveConfig('p1Name', this.value)">
                      <input type="color" id="st-p1-color" class="st-color" onchange="saveConfig('p1Color', this.value)">
                  </div>
              </div>
              <div class="setting-group">
                  <div class="setting-label">Player 2 (Right)</div>
                  <div class="flex-row">
                      <input type="text" id="st-p2-name" class="st-input" placeholder="Name" onchange="saveConfig('p2Name', this.value)">
                      <input type="color" id="st-p2-color" class="st-color" onchange="saveConfig('p2Color', this.value)">
                  </div>
              </div>
          </div>

          <div class="row-grid">
              <div class="setting-group">
                  <div class="setting-label">Global Theme</div>
                  <div class="flex-row">
                      <input type="color" id="st-theme-color" class="st-color" style="width:100%" onchange="saveConfig('theme', this.value)">
                  </div>
              </div>
              <div class="setting-group">
                  <div class="setting-label">Background Color</div>
                  <div class="flex-row">
                      <input type="color" id="st-bg-color" class="st-color" style="width:100%" onchange="saveConfig('bgColor', this.value)">
                  </div>
              </div>
          </div>
          
          <div class="setting-group">
              <div class="setting-label">Background Wallpaper</div>
              
              <div id="drop-zone" ondragover="dragOverHandler(event)" ondragleave="dragLeaveHandler(event)" ondrop="dropHandler(event)">
                  DROP IMAGE HERE
              </div>

              <div class="flex-row">
                  <input type="text" id="st-bg-url" class="st-input" placeholder="Paste URL..." onchange="saveConfig('bgUrl', this.value)">
                  <button class="st-btn action" onclick="addCurrentToSaved()">Save</button>
                  <button class="st-btn" onclick="saveConfig('bgUrl', '')">Clear</button>
              </div>
              <div class="saved-grid" id="saved-bg-list">
                  </div>
          </div>

      </div>
  </div>

  <div class="top-bar">
    <div class="top-left">
      <div class="live-status-container">
        <div class="status-badge"><div id="status-dot" class="status-dot active"></div> Live</div>
        <div id="presence-list" class="presence-text"><i class="fas fa-users" style="font-size: 9px;"></i> 0 Online</div>
      </div>
      
      <div class="np-widget">
        <img id="np-img-top" class="np-thumb-mini" src="">
        <div class="np-info"><div class="np-text" id="np-title-top">System Ready</div></div>
        
        <div class="np-controls">
            <button class="media-tiny-btn" onclick="mediaAction('prev')"><span class="material-icons">skip_previous</span></button>
            <button class="media-tiny-btn" onclick="mediaAction('play')" id="top-play-btn"><span class="material-icons">play_arrow</span></button>
            <button class="media-tiny-btn" onclick="mediaAction('next')"><span class="material-icons">skip_next</span></button>
        </div>

        <div class="top-vol">
            <button class="media-tiny-btn" onclick="toggleTopMute()" style="width:24px;"><span class="material-icons" id="top-vol-icon" style="font-size:16px;">volume_up</span></button>
            <input type="range" class="top-vol-slider" id="top-vol-slider" min="0" max="100" value="100" oninput="sendVolume(this.value)">
        </div>
      </div>
    </div>

    <div class="top-right">
      <div class="theme-btn-group">
        <div class="theme-color-btn" onclick="window.changeTheme()" title="Quick Random Theme"><i class="fas fa-palette"></i></div>
        <div class="theme-party-btn" onclick="window.toggleParty()" title="Party Mode"><i class="fas fa-infinity"></i></div>
        <div class="theme-gear-btn" onclick="toggleSettings()" title="Settings"><i class="fas fa-cog"></i></div>
      </div>
    </div>
  </div>

  <div class="stage">
    <div class="col-p">
      <div class="p-header">
          <div class="p-top-row">
              <div class="p-name" id="disp-p1-name" style="color:var(--red)">ALB</div>
              <div class="p-ctrls"><div class="tiny-btn" onclick="modScore('alb', 'add')">+</div><div class="tiny-btn" onclick="modScore('alb', 'sub')">-</div></div>
          </div>
          <div class="p-score" id="score-alb">0</div>
          <button class="col-btn export" id="export-alb" onclick="exportTeam('alb')" title="Export to Showdown"><i class="fas fa-file-export"></i></button>
      </div>
      <div class="slot-list" id="slots-alb"></div>
      <button class="col-btn clear-btn" onclick="clearCol('alb')">Clear</button>
    </div>

    <div class="col-c">
      <div class="tab-bar">
        <div class="tab active" onclick="switchTab('play', this)">Play</div>
        <div class="tab" onclick="switchTab('gen', this)">Generator</div>
        <div class="tab" onclick="switchTab('music', this)">Music</div>
        <div class="tab" onclick="switchTab('hist', this)">History</div>
      </div>
      <div id="view-play" class="tab-content active"><iframe id="frame-play" src="play.html" style="width:100%;height:100%;border:none;"></iframe></div>
      <div id="view-gen" class="tab-content" ondragover="allowReturnDrop(event)" ondrop="returnDrop(event)">
        <iframe id="frame-gen" src="gen.html" style="width:100%;height:100%;border:none; pointer-events:all;"></iframe>
      </div>
      <div id="view-music" class="tab-content"><iframe id="frame-music" src="music.html" style="width:100%;height:100%;border:none;"></iframe></div>
      <div id="view-hist" class="tab-content"><iframe id="frame-hist" src="history.html" style="width:100%;height:100%;border:none;"></iframe></div>
    </div>

    <div class="col-p">
      <div class="p-header">
          <div class="p-top-row">
              <div class="p-name" id="disp-p2-name" style="color:var(--blue)">BIU</div>
              <div class="p-ctrls"><div class="tiny-btn" onclick="modScore('biu', 'add')">+</div><div class="tiny-btn" onclick="modScore('biu', 'sub')">-</div></div>
          </div>
          <div class="p-score" id="score-biu">0</div>
          <button class="col-btn export" id="export-biu" onclick="exportTeam('biu')" title="Export to Showdown"><i class="fas fa-file-export"></i></button>
      </div>
      <div class="slot-list" id="slots-biu"></div>
      <button class="col-btn clear-btn" onclick="clearCol('biu')">Clear</button>
    </div>
  </div>

  <script>
    window.GEN_DRAG_PAYLOAD = null;
    var lastTopVol = 100;
    window.returningIndex = -1;
    window.SMOGON_CACHE = null; 
    
    // --- SETTINGS LOGIC ---
    window.toggleSettings = function() {
        let el = document.getElementById('settings-modal');
        el.style.display = (el.style.display === 'flex') ? 'none' : 'flex';
    };

    window.saveConfig = function(key, val) {
        db.ref('config/' + key).set(val);
    };

    // --- SYNC CONFIG ---
    db.ref('config').on('value', snap => {
        const c = snap.val() || {};
        
        // 1. Theme Color & Sync
        if(c.theme) {
            document.documentElement.style.setProperty('--accent', c.theme);
            document.getElementById('st-theme-color').value = c.theme;
            // SYNC IFRAMES
            ['frame-play', 'frame-gen', 'frame-music', 'frame-hist'].forEach(id => {
                let el = document.getElementById(id);
                if(el && el.contentWindow) el.contentWindow.postMessage({ type: 'THEME_UPDATE', color: c.theme }, '*');
            });
        }

        // 2. Background Image
        if(c.bgUrl) {
            document.body.style.backgroundImage = `url('${c.bgUrl}')`;
            document.getElementById('st-bg-url').value = c.bgUrl;
        } else {
            document.body.style.backgroundImage = 'none';
            document.getElementById('st-bg-url').value = '';
        }

        // 3. Background Color
        if(c.bgColor) {
            document.body.style.backgroundColor = c.bgColor;
            document.getElementById('st-bg-color').value = c.bgColor;
        }

        // 4. Saved Wallpapers
        renderSavedWallpapers(c.savedWallpapers || []);

        // 5. Player 1
        const p1Name = c.p1Name || "ALB";
        const p1Color = c.p1Color || "#ff4444";
        document.getElementById('disp-p1-name').innerText = p1Name;
        document.getElementById('disp-p1-name').style.color = p1Color;
        if(document.activeElement !== document.getElementById('st-p1-name')) 
            document.getElementById('st-p1-name').value = p1Name;
        document.getElementById('st-p1-color').value = p1Color;

        // 6. Player 2
        const p2Name = c.p2Name || "BIU";
        const p2Color = c.p2Color || "#4488ff";
        document.getElementById('disp-p2-name').innerText = p2Name;
        document.getElementById('disp-p2-name').style.color = p2Color;
        if(document.activeElement !== document.getElementById('st-p2-name')) 
            document.getElementById('st-p2-name').value = p2Name;
        document.getElementById('st-p2-color').value = p2Color;
    });

    // --- WALLPAPER MANAGER ---
    function addCurrentToSaved() {
        let current = document.getElementById('st-bg-url').value;
        if(!current) return;
        db.ref('config/savedWallpapers').once('value', snap => {
            let list = snap.val() || [];
            if(!list.includes(current)) {
                list.push(current);
                db.ref('config/savedWallpapers').set(list);
            }
        });
    }

    function removeWallpaper(idx) {
        db.ref('config/savedWallpapers').once('value', snap => {
            let list = snap.val() || [];
            list.splice(idx, 1);
            db.ref('config/savedWallpapers').set(list);
        });
    }

    function renderSavedWallpapers(list) {
        const container = document.getElementById('saved-bg-list');
        container.innerHTML = '';
        list.forEach((url, idx) => {
            let d = document.createElement('div');
            d.className = 'saved-thumb';
            d.style.backgroundImage = `url('${url}')`;
            d.onclick = () => saveConfig('bgUrl', url);
            d.innerHTML = `<div class="del-thumb" onclick="event.stopPropagation(); removeWallpaper(${idx})">&times;</div>`;
            container.appendChild(d);
        });
    }

    // --- SETTINGS DRAG DROP ---
    window.dragOverHandler = function(ev) {
        ev.preventDefault();
        document.getElementById('drop-zone').classList.add('drag-over');
    }
    
    window.dragLeaveHandler = function(ev) {
        document.getElementById('drop-zone').classList.remove('drag-over');
    }
    
    window.dropHandler = function(ev) {
        ev.preventDefault();
        document.getElementById('drop-zone').classList.remove('drag-over');
        if(ev.dataTransfer.files && ev.dataTransfer.files.length > 0) {
            const file = ev.dataTransfer.files[0];
            if(file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    saveConfig('bgUrl', e.target.result);
                };
                reader.readAsDataURL(file);
            }
        }
    }

    // --- PRESENCE LOGIC (FIXED) ---
    var myId = sessionStorage.getItem('presenceId');
    if (!myId) {
        myId = Date.now().toString() + Math.random().toString().slice(2,5);
        sessionStorage.setItem('presenceId', myId);
    }

    var presenceRef = db.ref('presence');
    var connectedRef = db.ref('.info/connected');
    
    connectedRef.on('value', function(snap) {
        if (snap.val() === true) {
            var userRef = presenceRef.child(myId);
            userRef.onDisconnect().remove();
            userRef.set(true);
        }
    });
    
    presenceRef.on('value', function(snap) {
        var val = snap.val() || {};
        var count = Object.keys(val).length;
        document.getElementById('presence-list').innerHTML = `<i class="fas fa-users" style="font-size: 9px;"></i> ${count} Online`;
    });


    // --- DASHBOARD SYNC ---
    db.ref('dashboard').on('value', snap => {
        if(window.syncLock) return; 
        const s = snap.val() || {};
        window.scores.alb = s.scoreAlb || 0; window.scores.biu = s.scoreBiu || 0;
        document.getElementById('score-alb').innerText = window.scores.alb;
        document.getElementById('score-biu').innerText = window.scores.biu;
        if(s.slotsAlb) renderColumn('alb', s.slotsAlb);
        if(s.slotsBiu) renderColumn('biu', s.slotsBiu);
    });

    db.ref('music/status').on('value', snap => {
        const m = snap.val() || {};
        const titleEl = document.getElementById('np-title-top');
        if(titleEl) titleEl.innerText = m.currentTitle || "System Ready";

        const imgEl = document.getElementById('np-img-top');
        if(imgEl) {
            imgEl.src = m.currentId ? `https://img.youtube.com/vi/${m.currentId}/mqdefault.jpg` : "";
            imgEl.style.display = m.currentId ? 'block' : 'none';
        }

        const playBtn = document.getElementById('top-play-btn');
        if(playBtn) {
            let isPlaying = (m.state === 'PLAYING');
            playBtn.innerHTML = isPlaying ? '<span class="material-icons">pause</span>' : '<span class="material-icons">play_arrow</span>';
        }
    });

    window.mediaAction = function(action) {
        if(action === 'play') {
            db.ref('music/status/state').once('value', snap => {
                let current = snap.val() || 'PAUSED'; 
                let next = (current === 'PLAYING') ? 'PAUSED' : 'PLAYING';
                db.ref('music/status/state').set(next);
            });
        } 
        else {
             db.ref('music/cmd').set({ action: action, time: Date.now() });
        }
    };

    window.sendVolume = function(val) {
        let frame = document.getElementById('frame-music');
        if(frame && frame.contentWindow) {
            frame.contentWindow.postMessage({ type: 'setVolume', value: val }, '*');
        }
        updateTopVolIcon(val);
        if(val > 0) lastTopVol = val;
    }

    window.toggleTopMute = function() {
        let slider = document.getElementById('top-vol-slider');
        let current = slider.value;
        if(current > 0) {
            sendVolume(0);
            slider.value = 0;
        } else {
            sendVolume(lastTopVol);
            slider.value = lastTopVol;
        }
    }

    function updateTopVolIcon(val) {
        let icon = document.getElementById('top-vol-icon');
        if(val == 0) icon.innerText = "volume_off";
        else if(val < 50) icon.innerText = "volume_down";
        else icon.innerText = "volume_up";
    }

    window.addEventListener('message', (event) => {
        if (event.data && event.data.type === 'requestClearCols') {
            clearCol('alb'); clearCol('biu');
        }
        if (event.data && event.data.type === 'GENERATOR_DROP') {
            handleReturnLogic();
        }
    });

    function handleReturnLogic() {
        if(window.returningId && window.returningElement) {
             let frame = document.getElementById('frame-gen');
             if(frame && frame.contentWindow) frame.contentWindow.postMessage({ type: 'freePokemon', id: window.returningId }, '*');
             
             window.returningElement.innerHTML = "";
             window.returningElement.classList.remove('filled');
             window.returningElement.draggable = false;
             
             var parentId = window.returningElement.parentElement.id;
             var side = parentId.split('-')[1]; 
             
             if(window.returningIndex !== -1) {
                 var dbKey = side === 'alb' ? 'slotsAlb' : 'slotsBiu';
                 db.ref('dashboard/' + dbKey + '/' + window.returningIndex).set(null);
             } else {
                 saveColumnState(side);
             }
             
             window.returningId = null; window.returningElement = null; window.returningIndex = -1;
        }
    }

    window.modScore = function(p, op) {
        window.syncLock = true;
        if(op==='add') window.scores[p]++; else window.scores[p] = Math.max(0, window.scores[p]-1);
        document.getElementById('score-'+p).innerText = window.scores[p];
        db.ref('dashboard/score' + (p==='alb'?'Alb':'Biu')).set(window.scores[p]);
        setTimeout(() => window.syncLock = false, 500);
    };

    window.initSlots = function(id) { 
        var h = ''; 
        for(var i=0; i<6; i++) h += `<div class="slot" data-idx="${i}" ondragover="allowDrop(event)" ondragleave="leaveDrop(event)" ondrop="drop(event)"></div>`; 
        document.getElementById(id).innerHTML = h; 
    };
    
    window.allowDrop = function(ev) { ev.preventDefault(); ev.currentTarget.classList.add('drag-over'); ev.dataTransfer.dropEffect = "copy"; };
    window.leaveDrop = function(ev) { ev.currentTarget.classList.remove('drag-over'); };
    
    window.drop = function(ev) { 
        ev.preventDefault(); 
        ev.currentTarget.classList.remove('drag-over'); 
        var data = window.GEN_DRAG_PAYLOAD;
        if(!data) { try { data = JSON.parse(ev.dataTransfer.getData("text/plain")); } catch(e){} }
        if(data) { 
            window.syncLock = true;
            ev.currentTarget.innerHTML = `<img src="${data.img}" onerror="this.src='https://play.pokemonshowdown.com/sprites/gen5/${data.id}.png'"><div class="slot-txt" data-id="${data.id}">${data.name}</div>`; 
            ev.currentTarget.classList.add('filled'); 
            ev.currentTarget.draggable = true;
            let idx = ev.currentTarget.dataset.idx;
            ev.currentTarget.ondragstart = function(e) { slotDragStart(e, data.id, idx); };
            var parentId = ev.currentTarget.parentElement.id;
            var side = parentId.split('-')[1]; 
            saveColumnState(side);
            let frame = document.getElementById('frame-gen');
            if(frame && frame.contentWindow) frame.contentWindow.postMessage({ type: 'markUsed', id: data.id }, '*');
            window.GEN_DRAG_PAYLOAD = null;
            setTimeout(() => window.syncLock = false, 1000);
        } 
    };
    
    function slotDragStart(e, id, idx) {
        e.dataTransfer.setData("text/return", id);
        e.dataTransfer.effectAllowed = "move";
        window.returningId = id; 
        window.returningElement = e.target;
        window.returningIndex = idx;
    }

    window.allowReturnDrop = function(ev) { if(window.returningId) ev.preventDefault(); };

    window.returnDrop = function(ev) {
        ev.preventDefault();
        handleReturnLogic();
    };

    window.clearCol = function(p) { 
        window.syncLock = true;
        var container = document.getElementById('slots-'+p);
        var kids = container.getElementsByClassName('slot');
        let frame = document.getElementById('frame-gen');
        for(var i=0; i<kids.length; i++) {
           var txt = kids[i].querySelector('.slot-txt');
           if(txt && txt.dataset.id && frame && frame.contentWindow) {
               frame.contentWindow.postMessage({ type: 'freePokemon', id: txt.dataset.id }, '*');
           }
        }
        window.initSlots('slots-'+p); 
        saveColumnState(p);
        setTimeout(() => window.syncLock = false, 1000);
    };
    
    // --- EXPORT WITH SMOGON CHAOS DATA ---
    window.exportTeam = async function(side) {
        var btn = document.getElementById('export-' + side);
        var originalIcon = '<i class="fas fa-file-export"></i>';
        
        // VISUAL LOADING
        btn.innerHTML = '<i class="fas fa-spinner"></i>';
        
        var container = document.getElementById('slots-' + side);
        var kids = container.getElementsByClassName('slot');
        var exportText = "";
        var monsToFetch = [];
        
        for(var i=0; i<kids.length; i++) {
            var txt = kids[i].querySelector('.slot-txt');
            if(txt && txt.dataset.id) {
                monsToFetch.push({ name: txt.innerText.trim(), id: txt.dataset.id });
            }
        }
        
        if(monsToFetch.length === 0) { 
            alert("Column is empty!"); 
            btn.innerHTML = originalIcon;
            return; 
        }

        // 1. Fetch Smogon Data if not cached
        if (!window.SMOGON_CACHE) {
            try {
                const proxyUrl = "https://corsproxy.io/?";
                const smogonUrl = "https://www.smogon.com/stats/2024-11/chaos/gen9ou-1695.json"; 
                const res = await fetch(proxyUrl + smogonUrl);
                if(res.ok) {
                    const json = await res.json();
                    window.SMOGON_CACHE = json.data; 
                }
            } catch(e) {
                console.warn("Smogon fetch failed, using fallback mode.");
            }
        }

        for (let mon of monsToFetch) {
            let smogonData = null;
            if (window.SMOGON_CACHE) {
                smogonData = window.SMOGON_CACHE[mon.name];
                if (!smogonData) {
                    let key = Object.keys(window.SMOGON_CACHE).find(k => k.toLowerCase().replace(/[^a-z0-9]/g, '') === mon.id.replace(/[^a-z0-9]/g, ''));
                    if(key) smogonData = window.SMOGON_CACHE[key];
                }
            }

            if (smogonData) {
                // --- SMOGON MODE ---
                exportText += `${mon.name} @ ${getTopKey(smogonData.Items) || 'Leftovers'}\n`;
                exportText += `Ability: ${getTopKey(smogonData.Abilities)}\n`;
                
                let topSpread = getTopKey(smogonData.Spreads); 
                if(topSpread) {
                    let parts = topSpread.split(':');
                    let nature = parts[0];
                    let evs = parts[1].split('/');
                    exportText += `${nature} Nature\n`;
                    exportText += `EVs: ${evs[0]} HP / ${evs[1]} Atk / ${evs[2]} Def / ${evs[3]} SpA / ${evs[4]} SpD / ${evs[5]} Spe\n`;
                } else {
                    exportText += `Serious Nature\n`;
                }

                let moves = getTopKeys(smogonData.Moves, 4);
                moves.forEach(m => exportText += `- ${m}\n`);
                exportText += `\n`;

            } else {
                // --- FALLBACK (PokÃ©API) ---
                try {
                    let query = mon.id.toLowerCase().replace(/[^a-z0-9]/g, '');
                    let res = await fetch(`https://pokeapi.co/api/v2/pokemon/${query}`);
                    if(!res.ok) throw new Error("Not found");
                    let data = await res.json();
                    
                    let stats = data.stats; 
                    let sortedStats = [...stats].sort((a,b) => b.base_stat - a.base_stat);
                    let best1 = sortedStats[0].stat.name;
                    let best2 = sortedStats[1].stat.name;
                    
                    const statMap = { 'hp':'HP', 'attack':'Atk', 'defense':'Def', 'special-attack':'SpA', 'special-defense':'SpD', 'speed':'Spe' };
                    let natureStat = best1 === 'hp' ? best2 : best1;
                    let natureMap = { 'attack':'Adamant', 'defense':'Impish', 'special-attack':'Modest', 'special-defense':'Calm', 'speed':'Jolly' };
                    let nature = natureMap[natureStat] || 'Serious';

                    let levelMoves = data.moves.filter(m => m.version_group_details.some(d => d.move_learn_method.name === 'level-up'));
                    let moves = levelMoves.slice(-4).map(m => m.move.name);
                    moves = moves.map(m => m.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' '));

                    exportText += `${mon.name} @ Leftovers\n`;
                    exportText += `Ability: ${data.abilities[0].ability.name.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ')}\n`;
                    exportText += `${nature} Nature\n`;
                    exportText += `EVs: 252 ${statMap[best1]} / 252 ${statMap[best2]} / 4 HP\n`;
                    if(moves.length > 0) moves.forEach(m => exportText += `- ${m}\n`);
                    else exportText += `- Tackle\n`;
                    exportText += `\n`;

                } catch(e) {
                    console.log("Export fallback failed for", mon.name);
                    exportText += `${mon.name}\n\n`;
                }
            }
        }

        // VISUAL DONE
        navigator.clipboard.writeText(exportText).then(function() {
            btn.innerHTML = '<i class="fas fa-check" style="color:var(--accent)"></i>';
            setTimeout(() => { btn.innerHTML = originalIcon; }, 2000);
        });
    }

    // Helper to find key with highest value in Smogon object
    function getTopKey(obj) {
        if(!obj) return null;
        return Object.keys(obj).reduce((a, b) => obj[a] > obj[b] ? a : b);
    }

    function getTopKeys(obj, n) {
        if(!obj) return [];
        return Object.keys(obj).sort((a,b) => obj[b] - obj[a]).slice(0, n);
    }

    function saveColumnState(side) {
        var slots = [];
        var container = document.getElementById('slots-'+side);
        var kids = container.getElementsByClassName('slot');
        for(var i=0; i<kids.length; i++) {
            var img = kids[i].querySelector('img');
            var txt = kids[i].querySelector('.slot-txt');
            if(img && txt) slots.push({ img: img.src, name: txt.innerText, id: txt.dataset.id });
            else slots.push(null);
        }
        db.ref('dashboard/slots' + (side==='alb'?'Alb':'Biu')).set(slots);
    }

    function renderColumn(side, data) {
        if(!data) return;
        var container = document.getElementById('slots-'+side);
        var kids = container.getElementsByClassName('slot');
        for(var i=0; i<kids.length; i++) {
            if(data[i]) {
                if(!kids[i].classList.contains('filled') || kids[i].innerText !== data[i].name) {
                    kids[i].innerHTML = `<img src="${data[i].img}" onerror="this.src='https://play.pokemonshowdown.com/sprites/gen5/${data[i].id}.png'"><div class="slot-txt" data-id="${data[i].id}">${data[i].name}</div>`;
                    kids[i].classList.add('filled');
                    kids[i].draggable = true;
                    let pid = data[i].id; 
                    let idx = i; 
                    kids[i].ondragstart = function(e) { slotDragStart(e, pid, idx); };
                }
            } else {
                if(kids[i].classList.contains('filled')) {
                    kids[i].innerHTML = "";
                    kids[i].classList.remove('filled');
                    kids[i].draggable = false;
                }
            }
        }
    }

    window.switchTab = function(viewId, btn) { 
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active')); 
        document.querySelectorAll('.tab').forEach(el => el.classList.remove('active')); 
        document.getElementById('view-'+viewId).classList.add('active'); 
        btn.classList.add('active'); 
    };

    document.addEventListener('DOMContentLoaded', function() {
        window.initSlots('slots-alb'); window.initSlots('slots-biu'); 
    });
  </script>
</body>
</html>
